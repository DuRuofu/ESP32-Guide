# ESP32ÁΩëÁªúÂÖ•Èó® - ESP-NOWÂçèËÆÆ

> [!TIP] üöÄ ESP-NOWÂçèËÆÆ | ESP32ËÆæÂ§áÈó¥ÁöÑ‰ΩéÂäüËÄóÊó†Á∫øÈÄö‰ø°  
> - üí° **Á¢éÁ¢éÂøµ**üòéÔºöÊú¨ËäÇÂ∞Ü‰ªãÁªçÂ¶Ç‰ΩïÂú® ESP32 ‰∏ä‰ΩøÁî® ESP-NOW ÂçèËÆÆÔºåÂÆûÁé∞‰ΩéÂäüËÄó„ÄÅÂø´ÈÄüÁöÑËÆæÂ§áÈó¥ÈÄö‰ø°„ÄÇ‰Ω†Â∞ÜÂ≠¶‰π†Â¶Ç‰ΩïÈÖçÁΩÆ ESP-NOWÔºåÂπ∂ËøõË°åÊï∞ÊçÆ‰º†Ëæì„ÄÇ  
> - üì∫ **ËßÜÈ¢ëÊïôÁ®ã**ÔºöÊöÇÊó†  
> - üíæ **Á§∫‰æã‰ª£Á†Å**Ôºö[ESP32-Guide/code/05.wifi/espnow](https://github.com/DuRuofu/ESP32-Guide/tree/main/code/05.wifi/espnow)


## ‰∏Ä„ÄÅÊ¶ÇËø∞

### 1.1 ESP-NOW‰ªãÁªç

>ËßÜÈ¢ë‰ªãÁªçÔºöhttps://www.espressif.com/sites/default/files/esp-now-zh.mp4

ESP-NOW ÊòØ‰∏ÄÁßçÁî±‰πêÈë´ÂÖ¨Âè∏ÂÆö‰πâÁöÑÊó†ËøûÊé• Wi-Fi ÈÄö‰ø°ÂçèËÆÆ„ÄÇÂú® ESP-NOW ‰∏≠ÔºåÂ∫îÁî®Á®ãÂ∫èÊï∞ÊçÆË¢´Â∞ÅË£ÖÂú®ÂêÑ‰∏™‰æõÂ∫îÂïÜÁöÑÂä®‰ΩúÂ∏ß‰∏≠ÔºåÁÑ∂ÂêéÂú®Êó†ËøûÊé•ÁöÑÊÉÖÂÜµ‰∏ãÔºå‰ªé‰∏Ä‰∏™ Wi-Fi ËÆæÂ§á‰º†ËæìÂà∞Âè¶‰∏Ä‰∏™ Wi-Fi ËÆæÂ§á„ÄÇ CTR ‰∏é CBC-MAC ÂçèËÆÆ (CCMP) ÂèØÁî®Êù•‰øùÊä§Âä®‰ΩúÂ∏ßÁöÑÂÆâÂÖ®„ÄÇESP-NOW ÂπøÊ≥õÂ∫îÁî®‰∫éÊô∫ËÉΩÁÖßÊòé„ÄÅËøúÁ®ãÊéßÂà∂„ÄÅ‰º†ÊÑüÂô®Á≠âÈ¢ÜÂüü„ÄÇ

ESP-NOW ÊòØÂü∫‰∫éÊï∞ÊçÆÈìæË∑ØÂ±ÇÁöÑÊó†Á∫øÈÄö‰ø°ÂçèËÆÆÔºåÂÆÉÂ∞Ü‰∫îÂ±Ç OSI ‰∏äÂ±ÇÂçèËÆÆÁ≤æÁÆÄ‰∏∫‰∏ÄÂ±ÇÔºåÊï∞ÊçÆ‰º†ËæìÊó∂Êó†ÈúÄ‰æùÊ¨°ÁªèËøáÁΩëÁªúÂ±Ç„ÄÅ‰º†ËæìÂ±Ç„ÄÅ‰ºöËØùÂ±Ç„ÄÅË°®Á§∫Â±Ç„ÄÅÂ∫îÁî®Â±ÇÁ≠âÂ§çÊùÇÁöÑÂ±ÇÁ∫ßÔºå‰πüÊó†ÈúÄÂ±ÇÂ±ÇÂ¢ûÂä†ÂåÖÂ§¥ÂíåËß£ÂåÖÔºåÂ§ßÂ§ßÁºìËß£‰∫ÜÁΩëÁªúÊã•Êå§Êó∂Âõ†‰∏∫‰∏¢ÂåÖËÄåÂØºËá¥ÁöÑÂç°È°øÂíåÂª∂ËøüÔºåÊã•ÊúâÊõ¥È´òÁöÑÂìçÂ∫îÈÄüÂ∫¶„ÄÇ

![](attachments/20240327133912.png)


### 1.2 ESP-NOW Êï∞ÊçÆÂ∏ßÊ†ºÂºè

> Êê¨ËøêËá™ÂÆòÊñπÊïôÁ®ã

ESP-NOW ‰ΩøÁî®ÂêÑ‰∏™‰æõÂ∫îÂïÜÁöÑÂä®‰ΩúÂ∏ß‰º†ËæìÊï∞ÊçÆÔºåÈªòËÆ§ÊØîÁâπÁéá‰∏∫ 1 Mbps„ÄÇÂêÑ‰∏™‰æõÂ∫îÂïÜÁöÑÂä®‰ΩúÂ∏ßÊ†ºÂºè‰∏∫Ôºö

| MAC Êä•Â§¥ | ÂàÜÁ±ª‰ª£Á†Å | ÁªÑÁªáÊ†áËØÜÁ¨¶ | ÈöèÊú∫ÂÄº  | ‰æõÂ∫îÂïÜÁâπÂÆöÂÜÖÂÆπ  | FCS  |
| ------ | ---- | ----- | ---- | -------- | ---- |
| 24 Â≠óËäÇ  | 1 Â≠óËäÇ | 3 Â≠óËäÇ  | 4 Â≠óËäÇ | 7~257 Â≠óËäÇ | 4 Â≠óËäÇ |

- ÂàÜÁ±ª‰ª£Á†ÅÔºöÂàÜÁ±ª‰ª£Á†ÅÂ≠óÊÆµÂèØÁî®‰∫éÊåáÁ§∫ÂêÑ‰∏™‰æõÂ∫îÂïÜÁöÑÁ±ªÂà´ÔºàÊØîÂ¶Ç 127Ôºâ„ÄÇ
- ÁªÑÁªáÊ†áËØÜÁ¨¶ÔºöÁªÑÁªáÊ†áËØÜÁ¨¶ÂåÖÂê´‰∏Ä‰∏™ÂîØ‰∏ÄÊ†áËØÜÁ¨¶ (ÊØîÂ¶Ç 0x18fe34)Ôºå‰∏∫‰πêÈë´ÊåáÂÆöÁöÑ MAC Âú∞ÂùÄÁöÑÂâç‰∏â‰∏™Â≠óËäÇ„ÄÇ
- ÈöèÊú∫ÂÄºÔºöÈò≤Ê≠¢ÈáçÊîæÊîªÂáª„ÄÇ
- ‰æõÂ∫îÂïÜÁâπÂÆöÂÜÖÂÆπÔºö‰æõÂ∫îÂïÜÁâπÂÆöÂÜÖÂÆπÂåÖÂê´‰æõÂ∫îÂïÜÁâπÂÆöÂ≠óÊÆµÔºåÂ¶Ç‰∏ãÊâÄÁ§∫Ôºö

| ÂÖÉÁ¥† ID | ÈïøÂ∫¶ | ÁªÑÁªáÊ†áËØÜÁ¨¶ | Á±ªÂûã | ÁâàÊú¨ | Ê≠£Êñá |
| ------- | ---- | ---------- | ---- | ---- | ---- |
|    1 Â≠óËäÇ        |   1 Â≠óËäÇ      |     3 Â≠óËäÇ         | 1 Â≠óËäÇ     |  1 Â≠óËäÇ    | 0ÔΩû250 Â≠óËäÇ      |

- ÂÖÉÁ¥† IDÔºöÂÖÉÁ¥† ID Â≠óÊÆµÂèØÁî®‰∫éÊåáÁ§∫ÁâπÂÆö‰∫é‰æõÂ∫îÂïÜÁöÑÂÖÉÁ¥†„ÄÇ
- ÈïøÂ∫¶ÔºöÈïøÂ∫¶ÊòØÁªÑÁªáÊ†áËØÜÁ¨¶„ÄÅÁ±ªÂûã„ÄÅÁâàÊú¨ÂíåÊ≠£ÊñáÁöÑÊÄªÈïøÂ∫¶„ÄÇ
- ÁªÑÁªáÊ†áËØÜÁ¨¶ÔºöÁªÑÁªáÊ†áËØÜÁ¨¶ÂåÖÂê´‰∏Ä‰∏™ÂîØ‰∏ÄÊ†áËØÜÁ¨¶ (ÊØîÂ¶Ç 0x18fe34)Ôºå‰∏∫‰πêÈë´ÊåáÂÆöÁöÑ MAC Âú∞ÂùÄÁöÑÂâç‰∏â‰∏™Â≠óËäÇ„ÄÇ
- Á±ªÂûãÔºöÁ±ªÂûãÂ≠óÊÆµËÆæÁΩÆ‰∏∫ 4Ôºå‰ª£Ë°® ESP-NOW„ÄÇ
- ÁâàÊú¨ÔºöÁâàÊú¨Â≠óÊÆµËÆæÁΩÆ‰∏∫ ESP-NOW ÁöÑÁâàÊú¨„ÄÇ
- Ê≠£ÊñáÔºöÊ≠£ÊñáÂåÖÂê´ ESP-NOW Êï∞ÊçÆ„ÄÇ

Áî±‰∫é ESP-NOW ÊòØÊó†ËøûÊé•ÁöÑÔºåÂõ†Ê≠§ MAC Êä•Â§¥‰∏éÊ†áÂáÜÂ∏ßÁï•Êúâ‰∏çÂêå„ÄÇFrameControl Â≠óÊÆµÁöÑ FromDS Âíå ToDS ‰ΩçÂùá‰∏∫ 0„ÄÇÁ¨¨‰∏Ä‰∏™Âú∞ÂùÄÂ≠óÊÆµÁî®‰∫éÈÖçÁΩÆÁõÆÊ†áÂú∞ÂùÄ„ÄÇÁ¨¨‰∫å‰∏™Âú∞ÂùÄÂ≠óÊÆµÁî®‰∫éÈÖçÁΩÆÊ∫êÂú∞ÂùÄ„ÄÇÁ¨¨‰∏â‰∏™Âú∞ÂùÄÂ≠óÊÆµÁî®‰∫éÈÖçÁΩÆÂπøÊí≠Âú∞ÂùÄ (0xff:0xff:0xff:0xff:0xff:0xff)„ÄÇ

## ‰∫å„ÄÅ‰ΩøÁî®

>‰ΩøÁî®ESP-NOWÁöÑÂü∫Êú¨Êù°‰ª∂ÊòØË¶ÅÁü•ÈÅìESP32ÁöÑMACÂú∞ÂùÄ

ÂèØ‰ª•‰ΩøÁî®[base_mac_address](https://github.com/espressif/esp-idf/tree/v5.1.3/examples/system/base_mac_address)ÂéÜÁ®ãËé∑ÂèñËäØÁâáMACÂú∞ÂùÄÔºö

![](attachments/20240327141511.png)

### 2.1 ÂàùÂßãÂåñ

Ë∞ÉÁî®¬†[`esp_now_init()`](https://docs.espressif.com/projects/esp-idf/zh_CN/latest/esp32c3/api-reference/network/esp_now.html#_CPPv412esp_now_initv "esp_now_init")¬†ÂàùÂßãÂåñ ESP-NOWÔºåË∞ÉÁî®¬†[`esp_now_deinit()`](https://docs.espressif.com/projects/esp-idf/zh_CN/latest/esp32c3/api-reference/network/esp_now.html#_CPPv414esp_now_deinitv "esp_now_deinit")¬†ÂèçÂàùÂßãÂåñ ESP-NOW„ÄÇESP-NOW Êï∞ÊçÆÂøÖÈ°ªÂú® Wi-Fi ÂêØÂä®Âêé‰º†ËæìÔºåÂõ†Ê≠§Âª∫ËÆÆÂú®ÂàùÂßãÂåñ ESP-NOW ‰πãÂâçÂêØÂä® Wi-FiÔºåÂπ∂Âú®ÂèçÂàùÂßãÂåñ ESP-NOW ‰πãÂêéÂÅúÊ≠¢ Wi-Fi„ÄÇ

ÂΩìË∞ÉÁî®¬†[`esp_now_deinit()`](https://docs.espressif.com/projects/esp-idf/zh_CN/latest/esp32c3/api-reference/network/esp_now.html#_CPPv414esp_now_deinitv "esp_now_deinit")¬†Êó∂ÔºåÈÖçÂØπËÆæÂ§áÁöÑÊâÄÊúâ‰ø°ÊÅØÈÉΩÂ∞ÜË¢´Âà†Èô§„ÄÇ
### 2.2 ËÆæÂ§áÈÖçÂØπ

Âú®Â∞ÜÊï∞ÊçÆÂèëÈÄÅÂà∞ÂÖ∂‰ªñËÆæÂ§á‰πãÂâçÔºåËØ∑ÂÖàË∞ÉÁî®¬†[`esp_now_add_peer()`](https://docs.espressif.com/projects/esp-idf/zh_CN/latest/esp32c3/api-reference/network/esp_now.html#_CPPv416esp_now_add_peerPK19esp_now_peer_info_t "esp_now_add_peer")¬†Â∞ÜÂÖ∂Ê∑ªÂä†Âà∞ÈÖçÂØπËÆæÂ§áÂàóË°®‰∏≠„ÄÇÂ¶ÇÊûúÂêØÁî®‰∫ÜÂä†ÂØÜÔºåÂàôÂøÖÈ°ªËÆæÁΩÆ LMK„ÄÇESP-NOW Êï∞ÊçÆÂèØ‰ª•‰ªé Station Êàñ SoftAP Êé•Âè£ÂèëÈÄÅ„ÄÇÁ°Æ‰øùÂú®ÂèëÈÄÅ ESP-NOW Êï∞ÊçÆ‰πãÂâçÂ∑≤ÂêØÁî®ËØ•Êé•Âè£„ÄÇ
ÈÖçÂØπËÆæÂ§áÁöÑÊúÄÂ§ßÊï∞ÈáèÊòØ 20ÔºåÂÖ∂‰∏≠Âä†ÂØÜËÆæÂ§áÁöÑÊï∞Èáè‰∏çË∂ÖËøá 17ÔºåÈªòËÆ§ÂÄºÊòØ 7„ÄÇ
### 2.3 ÂèëÈÄÅÊï∞ÊçÆ

Ë∞ÉÁî®¬†[`esp_now_send()`](https://docs.espressif.com/projects/esp-idf/zh_CN/latest/esp32c3/api-reference/network/esp_now.html#_CPPv412esp_now_sendPK7uint8_tPK7uint8_t6size_t "esp_now_send")¬†ÂèëÈÄÅ ESP-NOW Êï∞ÊçÆÔºåË∞ÉÁî®¬†[`esp_now_register_send_cb()`](https://docs.espressif.com/projects/esp-idf/zh_CN/latest/esp32c3/api-reference/network/esp_now.html#_CPPv424esp_now_register_send_cb17esp_now_send_cb_t "esp_now_register_send_cb")¬†Ê≥®ÂÜåÂèëÈÄÅÂõûË∞ÉÂáΩÊï∞„ÄÇÂ¶ÇÊûú MAC Â±ÇÊàêÂäüÊé•Êî∂Âà∞Êï∞ÊçÆÔºåÂàôËØ•ÂáΩÊï∞Â∞ÜËøîÂõû¬†ESP_NOW_SEND_SUCCESS¬†‰∫ã‰ª∂„ÄÇÂê¶ÂàôÔºåÂÆÉÂ∞ÜËøîÂõû¬†ESP_NOW_SEND_FAIL„ÄÇ

Â¶ÇÊûúÊúâÂ§ßÈáè ESP-NOW Êï∞ÊçÆË¶ÅÂèëÈÄÅÔºåË∞ÉÁî®¬†`esp_now_send()`¬†Êó∂ÈúÄÊ≥®ÊÑèÂçïÊ¨°ÂèëÈÄÅÁöÑÊï∞ÊçÆ‰∏çËÉΩË∂ÖËøá 250 Â≠óËäÇ„ÄÇËØ∑Ê≥®ÊÑèÔºå‰∏§‰∏™ ESP-NOW Êï∞ÊçÆÂåÖÁöÑÂèëÈÄÅÈó¥ÈöîÂ§™Áü≠ÂèØËÉΩÂØºËá¥ÂõûË∞ÉÂáΩÊï∞ËøîÂõûÊ∑∑‰π±„ÄÇÂõ†Ê≠§ÔºåÂª∫ËÆÆÂú®Á≠âÂà∞‰∏ä‰∏ÄÊ¨°ÂõûË∞ÉÂáΩÊï∞ËøîÂõû ACK ÂêéÂÜçÂèëÈÄÅ‰∏ã‰∏Ä‰∏™ ESP-NOW Êï∞ÊçÆ„ÄÇ
### 2.4 Êé•Êî∂Êï∞ÊçÆ

Ë∞ÉÁî®¬†[`esp_now_register_recv_cb()`](https://docs.espressif.com/projects/esp-idf/zh_CN/latest/esp32c3/api-reference/network/esp_now.html#_CPPv424esp_now_register_recv_cb17esp_now_recv_cb_t "esp_now_register_recv_cb")¬†Ê≥®ÂÜåÊé•Êî∂ÂõûË∞ÉÂáΩÊï∞„ÄÇÂΩìÊé•Êî∂ ESP-NOW Êï∞ÊçÆÊó∂ÔºåÈúÄË¶ÅË∞ÉÁî®Êé•Êî∂ÂõûË∞ÉÂáΩÊï∞„ÄÇÊé•Êî∂ÂõûË∞ÉÂáΩÊï∞‰πüÂú® Wi-Fi ‰ªªÂä°‰ªªÂä°‰∏≠ËøêË°å„ÄÇÂõ†Ê≠§Ôºå‰∏çË¶ÅÂú®ÂõûË∞ÉÂáΩÊï∞‰∏≠ÊâßË°åÂÜóÈïøÁöÑÊìç‰Ωú„ÄÇ Áõ∏ÂèçÔºåÂ∞ÜÂøÖË¶ÅÁöÑÊï∞ÊçÆÂèëÂ∏ÉÂà∞ÈòüÂàóÔºåÂπ∂‰∫§Áªô‰ºòÂÖàÁ∫ßËæÉ‰ΩéÁöÑ‰ªªÂä°Â§ÑÁêÜ„ÄÇ

## ‰∏â„ÄÅÁ§∫‰æã

### 3.1 ÂèëÈÄÅ

> Ê≥®ÊÑèÔºöÂèëÈÄÅÈúÄË¶ÅÊé•Êî∂ÊñπÁöÑMACÂú∞ÂùÄ

```c
#include <stdlib.h>
#include <time.h>
#include <string.h>
#include <assert.h>
#include "freertos/FreeRTOS.h"
#include "freertos/semphr.h"
#include "freertos/timers.h"
#include "nvs_flash.h"
#include "esp_random.h"
#include "esp_event.h"
#include "esp_netif.h"
#include "esp_wifi.h"
#include "esp_log.h"
#include "esp_mac.h"
#include "esp_now.h"
#include "esp_crc.h"

// Êé•Êî∂ÊñπÂú∞ÂùÄ
//static uint8_t s_broadcast_mac[ESP_NOW_ETH_ALEN] = {0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF};
static uint8_t s_broadcast_mac[ESP_NOW_ETH_ALEN] = {0x24, 0xdc, 0xc3, 0x9c, 0xeb, 0x18};

static const char *TAG = "espnow";

/* WiFi should start before using ESPNOW */
static void wifi_init(void)
{
	ESP_ERROR_CHECK(esp_netif_init());
	ESP_ERROR_CHECK(esp_event_loop_create_default());
	wifi_init_config_t cfg = WIFI_INIT_CONFIG_DEFAULT();
	ESP_ERROR_CHECK(esp_wifi_init(&cfg));
	ESP_ERROR_CHECK(esp_wifi_set_storage(WIFI_STORAGE_RAM));
	ESP_ERROR_CHECK(esp_wifi_set_mode(WIFI_MODE_STA));
	ESP_ERROR_CHECK(esp_wifi_start());

}

static void example_espnow_send_cb(const uint8_t *mac_addr, esp_now_send_status_t status)
{
	if (status != ESP_NOW_SEND_SUCCESS)
	{
		ESP_LOGE(TAG, "Send error");
	}
	else
	{
		ESP_LOGI(TAG, "Send success");
	}
}

// ESPNOWÂèëÈÄÅ‰ªªÂä°
static void espnow_task(void *pvParameter)
{
	char send_msg[] = "ESPNOW test!";
	ESP_LOGI(TAG, "Start sending broadcast data");
	while (1)
	{
		// ÂèëÈÄÅÊï∞ÊçÆ
		if (esp_now_send(s_broadcast_mac, (uint8_t *)send_msg, sizeof(send_msg)) != ESP_OK)
		{
			ESP_LOGE(TAG, "Send error");
		}
		vTaskDelay(1000 / portTICK_PERIOD_MS);
	}
}

static esp_err_t espnow_init(void)
{

	/* Initialize ESPNOW and register sending and receiving callback function. */
	ESP_ERROR_CHECK(esp_now_init());
	// Ê≥®ÂÜåÂèëÈÄÅÂõûË∞ÉÂáΩÊï∞
	ESP_ERROR_CHECK(esp_now_register_send_cb(example_espnow_send_cb));
	//ESP_ERROR_CHECK(esp_now_register_recv_cb(example_espnow_recv_cb));

	// Â∞ÜÂπøÊí≠ÂØπÁ≠âÊñπ‰ø°ÊÅØÊ∑ªÂä†Âà∞ÂØπÁ≠âÊñπÂàóË°®
	esp_now_peer_info_t *peer = malloc(sizeof(esp_now_peer_info_t));
	if (peer == NULL)
	{
		ESP_LOGE(TAG, "Malloc peer information fail");
		esp_now_deinit();
		return ESP_FAIL;
	}
	// ÂàùÂßãÂåñÂØπÁ≠âÊñπ‰ø°ÊÅØ
	memset(peer, 0, sizeof(esp_now_peer_info_t));
	peer->channel = 1;
	peer->ifidx = ESP_IF_WIFI_STA;
	peer->encrypt = false;
	memcpy(peer->peer_addr, s_broadcast_mac, ESP_NOW_ETH_ALEN);
	// Ê∑ªÂä†ÂØπÁ≠âÊñπ
	ESP_ERROR_CHECK(esp_now_add_peer(peer));
	free(peer);

	xTaskCreate(espnow_task, "espnow_task", 2048, NULL, 4, NULL);

	return ESP_OK;
}

void app_main(void)
{
	// Initialize NVS
	esp_err_t ret = nvs_flash_init();
	if (ret == ESP_ERR_NVS_NO_FREE_PAGES || ret == ESP_ERR_NVS_NEW_VERSION_FOUND)
	{
		ESP_ERROR_CHECK(nvs_flash_erase());
		ret = nvs_flash_init();
	}
	ESP_ERROR_CHECK(ret);

	// Initialize WiFi
	wifi_init();

	// Initialize ESPNOW
	espnow_init();
}

```

### 3.2 Êé•Êî∂

```c
#include <stdlib.h>
#include <time.h>
#include <string.h>
#include <assert.h>
#include "freertos/FreeRTOS.h"
#include "freertos/semphr.h"
#include "freertos/timers.h"
#include "nvs_flash.h"
#include "esp_random.h"
#include "esp_event.h"
#include "esp_netif.h"
#include "esp_wifi.h"
#include "esp_log.h"
#include "esp_mac.h"
#include "esp_now.h"
#include "esp_crc.h"

// Êé•Êî∂ÊñπÂú∞ÂùÄ
// static uint8_t s_broadcast_mac[ESP_NOW_ETH_ALEN] = {0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF};
static uint8_t s_broadcast_mac[ESP_NOW_ETH_ALEN] = {0x24, 0xdc, 0xc3, 0x9c, 0xeb, 0x18};

static const char *TAG = "espnow";

/* WiFi should start before using ESPNOW */
static void wifi_init(void)
{
	ESP_ERROR_CHECK(esp_netif_init());
	ESP_ERROR_CHECK(esp_event_loop_create_default());
	wifi_init_config_t cfg = WIFI_INIT_CONFIG_DEFAULT();
	ESP_ERROR_CHECK(esp_wifi_init(&cfg));
	ESP_ERROR_CHECK(esp_wifi_set_storage(WIFI_STORAGE_RAM));
	ESP_ERROR_CHECK(esp_wifi_set_mode(WIFI_MODE_STA));
	ESP_ERROR_CHECK(esp_wifi_start());
}

// ESPNOWÊé•Êî∂ÂõûË∞ÉÂáΩÊï∞
static void example_espnow_recv_cb(const esp_now_recv_info_t *recv_info, const uint8_t *data, int len)
{
	ESP_LOGI(TAG, "Receive data from: " MACSTR ", len: %d", MAC2STR(recv_info->src_addr), len);
	ESP_LOGI(TAG, "Data: %s", data);
}

// ESPNOWÊé•ÂèóÊï∞ÊçÆ‰ªªÂä°
static void espnow_task(void *pvParameter)
{
	ESP_LOGI(TAG, "Start receiving data");
	while (1)
	{
		vTaskDelay(1000 / portTICK_PERIOD_MS);
	}
}

static esp_err_t espnow_init(void)
{

	/* Initialize ESPNOW and register sending and receiving callback function. */
	ESP_ERROR_CHECK(esp_now_init());
	// Ê≥®ÂÜåÊé•ÂèóÂõûË∞ÉÂáΩÊï∞
	//ESP_ERROR_CHECK(esp_now_register_send_cb(example_espnow_send_cb));
	ESP_ERROR_CHECK(esp_now_register_recv_cb(example_espnow_recv_cb));

	xTaskCreate(espnow_task, "espnow_task", 2048, NULL, 4, NULL);

	return ESP_OK;
}

void app_main(void)
{
	// Initialize NVS
	esp_err_t ret = nvs_flash_init();
	if (ret == ESP_ERR_NVS_NO_FREE_PAGES || ret == ESP_ERR_NVS_NEW_VERSION_FOUND)
	{
		ESP_ERROR_CHECK(nvs_flash_erase());
		ret = nvs_flash_init();
	}
	ESP_ERROR_CHECK(ret);

	// Initialize WiFi
	wifi_init();

	// Initialize ESPNOW
	espnow_init();
}

```

ÊïàÊûúÔºö

![](attachments/20240327152252.png)

# ÂèÇËÄÉÈìæÊé•

1. https://github.com/espressif/esp-idf/blob/v5.1.3/examples/wifi/espnow/main/espnow_example.h
2. https://docs.espressif.com/projects/esp-idf/zh_CN/latest/esp32c3/api-reference/network/esp_now.html