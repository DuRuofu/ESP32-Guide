

# ESP32å¤–è®¾-ç¡¬ä»¶å®šæ—¶å™¨å…¥é—¨

> [!TIP] ğŸš€ ESP32 å¤–è®¾-ç¡¬ä»¶å®šæ—¶å™¨å…¥é—¨ | ç²¾å‡†å®šæ—¶ï¼Œæ§åˆ¶æ›´çµæ´»  
> - ğŸ’¡ **ç¢ç¢å¿µ**ğŸ˜ï¼šæœ¬èŠ‚å°†ä»‹ç» ESP32 çš„ç¡¬ä»¶å®šæ—¶å™¨ï¼Œå¸®åŠ©ä½ å®ç°ç²¾å‡†çš„å®šæ—¶æ§åˆ¶ï¼Œæå‡ç³»ç»Ÿå“åº”èƒ½åŠ›ã€‚  
> - ğŸ“º **è§†é¢‘æ•™ç¨‹**ï¼šğŸš§ *å¼€å‘ä¸­*  
> - ğŸ’¾ **ç¤ºä¾‹ä»£ç **ï¼š[ESP32-Guide/code/04.peripheral/basics/gptimer](https://github.com/DuRuofu/ESP32-Guide/tree/main/code/04.peripheral/basics/gptimer)


> è‹¥ä¸å¿…ä½¿ç”¨ç¡¬ä»¶å®šæ—¶å™¨ï¼Œåˆ™å»ºè®®ä½¿ç”¨è½¯ä»¶å®šæ—¶å™¨ï¼š[ESP å®šæ—¶å™¨](https://docs.espressif.com/projects/esp-idf/zh_CN/latest/esp32/api-reference/system/esp_timer.html)
## ä¸€ã€ä»‹ç»ï¼š

é€šç”¨å®šæ—¶å™¨æ˜¯ ESP32 å®šæ—¶å™¨ç»„å¤–è®¾çš„é©±åŠ¨ç¨‹åºã€‚ESP32 ç¡¬ä»¶å®šæ—¶å™¨åˆ†è¾¨ç‡é«˜ï¼Œå…·æœ‰çµæ´»çš„æŠ¥è­¦åŠŸèƒ½ã€‚å®šæ—¶å™¨å†…éƒ¨è®¡æ•°å™¨è¾¾åˆ°ç‰¹å®šç›®æ ‡æ•°å€¼çš„è¡Œä¸ºè¢«ç§°ä¸ºå®šæ—¶å™¨æŠ¥è­¦ã€‚å®šæ—¶å™¨æŠ¥è­¦æ—¶å°†è°ƒç”¨ç”¨æˆ·æ³¨å†Œçš„ä¸åŒå®šæ—¶å™¨å›è°ƒå‡½æ•°ã€‚

é€šç”¨å®šæ—¶å™¨é€šå¸¸åœ¨ä»¥ä¸‹åœºæ™¯ä¸­ä½¿ç”¨ï¼š
- å¦‚åŒæŒ‚é’Ÿä¸€èˆ¬è‡ªç”±è¿è¡Œï¼Œéšæ—¶éšåœ°è·å–é«˜åˆ†è¾¨ç‡æ—¶é—´æˆ³ï¼›
- ç”Ÿæˆå‘¨æœŸæ€§è­¦æŠ¥ï¼Œå®šæœŸè§¦å‘äº‹ä»¶ï¼›
- ç”Ÿæˆä¸€æ¬¡æ€§è­¦æŠ¥ï¼Œåœ¨ç›®æ ‡æ—¶é—´å†…å“åº”ã€‚

ESP32 å†…ç½® 4 ä¸ª 64-bit é€šç”¨å®šæ—¶å™¨ã€‚æ¯ä¸ªå®šæ—¶å™¨åŒ…å«ä¸€ä¸ª 16-bit é¢„åˆ†é¢‘å™¨å’Œä¸€ä¸ª 64-bit å¯è‡ªåŠ¨é‡æ–°åŠ è½½å‘ä¸Š ï¼å‘ä¸‹è®¡æ•°å™¨ã€‚ ESP32 çš„å®šæ—¶å™¨åˆ†ä¸º 2 ç»„ï¼Œæ¯ç»„ 2 ä¸ªã€‚TIMGn_Tx çš„ n ä»£è¡¨ç»„åˆ«ï¼Œx ä»£è¡¨å®šæ—¶å™¨ç¼–å·ã€‚

å®šæ—¶å™¨ç‰¹æ€§ï¼š 

â€¢ 16-bit æ—¶é’Ÿé¢„åˆ†é¢‘å™¨ï¼Œåˆ†é¢‘ç³»æ•°ä¸º 2-65536 
â€¢ 64-bit æ—¶åŸºè®¡æ•°å™¨ 
â€¢ å¯é…ç½®çš„å‘ä¸Šï¼å‘ä¸‹æ—¶åŸºè®¡æ•°å™¨ï¼šå¢åŠ æˆ–å‡å°‘ 
â€¢ æš‚åœå’Œæ¢å¤æ—¶åŸºè®¡æ•°å™¨ 
â€¢ æŠ¥è­¦æ—¶è‡ªåŠ¨é‡æ–°åŠ è½½ 
â€¢ å½“æŠ¥è­¦å€¼æº¢å‡º/ä½äºä¿æŠ¤å€¼æ—¶æŠ¥è­¦ 
â€¢ è½¯ä»¶æ§åˆ¶çš„å³æ—¶é‡æ–°åŠ è½½ 
â€¢ ç”µå¹³è§¦å‘ä¸­æ–­å’Œè¾¹æ²¿è§¦å‘ä¸­æ–­

## äºŒã€ä½¿ç”¨ï¼š

ESP32å†…ç½®äº†ä¸¤ä¸ªå®šæ—¶å™¨ç»„Â `Timer Group`ï¼Œæ¯ä¸ªå®šæ—¶å™¨ç»„éƒ½æœ‰ä¸¤ä¸ª64ä½å®šæ—¶å™¨`Timer`ã€‚æ”¯æŒå‘ä¸Šã€å‘ä¸‹ä¸¤ä¸ªæ–¹å‘è®¡æ•°ã€‚æ”¯æŒè®¾ç½®è­¦æŠ¥é˜ˆå€¼ã€‚

#### 1ã€[å®šæ—¶å™¨åˆå§‹åŒ–](https://docs.espressif.com/projects/esp-idf/zh_CN/latest/esp32/api-reference/peripherals/gptimer.html#gptimer-resource-allocation)

é€šç”¨å®šæ—¶å™¨å®ä¾‹ç”±Â [`gptimer_handle_t`](https://docs.espressif.com/projects/esp-idf/zh_CN/latest/esp32/api-reference/peripherals/gptimer.html#_CPPv416gptimer_handle_t "gptimer_handle_t")Â è¡¨ç¤ºã€‚

è¦åˆå§‹åŒ–ä¸€ä¸ªå®šæ—¶å™¨å®ä¾‹ï¼Œéœ€è¦æå‰æä¾›é…ç½®ç»“æ„ä½“Â [`gptimer_config_t`](https://docs.espressif.com/projects/esp-idf/zh_CN/latest/esp32/api-reference/peripherals/gptimer.html#_CPPv416gptimer_config_t "gptimer_config_t")ï¼Œå‚æ•°å¦‚ä¸‹ï¼š

- [`gptimer_config_t::clk_src`](https://docs.espressif.com/projects/esp-idf/zh_CN/latest/esp32/api-reference/peripherals/gptimer.html#_CPPv4N16gptimer_config_t7clk_srcE "gptimer_config_t::clk_src")Â é€‰æ‹©å®šæ—¶å™¨çš„æ—¶é’Ÿæºã€‚[`gptimer_clock_source_t`](https://docs.espressif.com/projects/esp-idf/zh_CN/latest/esp32/api-reference/peripherals/gptimer.html#_CPPv422gptimer_clock_source_t "gptimer_clock_source_t")Â ä¸­åˆ—å‡ºå¤šä¸ªå¯ç”¨æ—¶é’Ÿï¼Œä»…å¯é€‰æ‹©å…¶ä¸­ä¸€ä¸ªæ—¶é’Ÿã€‚
- [`gptimer_config_t::direction`](https://docs.espressif.com/projects/esp-idf/zh_CN/latest/esp32/api-reference/peripherals/gptimer.html#_CPPv4N16gptimer_config_t9directionE "gptimer_config_t::direction")Â è®¾ç½®å®šæ—¶å™¨çš„è®¡æ•°æ–¹å‘ï¼Œ[`gptimer_count_direction_t`](https://docs.espressif.com/projects/esp-idf/zh_CN/latest/esp32/api-reference/peripherals/gptimer.html#_CPPv425gptimer_count_direction_t "gptimer_count_direction_t")Â ä¸­åˆ—å‡ºå¤šä¸ªæ”¯æŒçš„æ–¹å‘ï¼Œä»…å¯é€‰æ‹©å…¶ä¸­ä¸€ä¸ªæ–¹å‘ã€‚
- [`gptimer_config_t::resolution_hz`](https://docs.espressif.com/projects/esp-idf/zh_CN/latest/esp32/api-reference/peripherals/gptimer.html#_CPPv4N16gptimer_config_t13resolution_hzE "gptimer_config_t::resolution_hz")Â è®¾ç½®å†…éƒ¨è®¡æ•°å™¨çš„åˆ†è¾¨ç‡ã€‚è®¡æ•°å™¨æ¯æ»´ç­”ä¸€æ¬¡ç›¸å½“äºÂ **1 / resolution_hz**Â ç§’ã€‚
- `gptimer_config::intr_priority`Â è®¾ç½®ä¸­æ–­çš„ä¼˜å…ˆçº§ã€‚å¦‚æœè®¾ç½®ä¸ºÂ `0`ï¼Œåˆ™ä¼šåˆ†é…ä¸€ä¸ªé»˜è®¤ä¼˜å…ˆçº§çš„ä¸­æ–­ï¼Œå¦åˆ™ä¼šä½¿ç”¨æŒ‡å®šçš„ä¼˜å…ˆçº§ã€‚
- é€‰ç”¨Â [`gptimer_config_t::intr_shared`](https://docs.espressif.com/projects/esp-idf/zh_CN/latest/esp32/api-reference/peripherals/gptimer.html#_CPPv4N16gptimer_config_t11intr_sharedE "gptimer_config_t::intr_shared")Â è®¾ç½®æ˜¯å¦å°†å®šæ—¶å™¨ä¸­æ–­æºæ ‡è®°ä¸ºå…±äº«æºã€‚

é…ç½®å¥½ç»“æ„ä½“ï¼Œå°†ç»“æ„ä¼ é€’ç»™Â [`gptimer_new_timer()`](https://docs.espressif.com/projects/esp-idf/zh_CN/latest/esp32/api-reference/peripherals/gptimer.html#_CPPv417gptimer_new_timerPK16gptimer_config_tP16gptimer_handle_t "gptimer_new_timer")ï¼Œç”¨ä»¥å®ä¾‹åŒ–å®šæ—¶å™¨å®ä¾‹å¹¶è¿”å›å®šæ—¶å™¨å¥æŸ„ã€‚

å¦‚å·²ä¸å†éœ€è¦ä¹‹å‰åˆ›å»ºçš„é€šç”¨å®šæ—¶å™¨å®ä¾‹ï¼Œåº”é€šè¿‡è°ƒç”¨Â [`gptimer_del_timer()`](https://docs.espressif.com/projects/esp-idf/zh_CN/latest/esp32/api-reference/peripherals/gptimer.html#_CPPv417gptimer_del_timer16gptimer_handle_t "gptimer_del_timer")Â å›æ”¶å®šæ—¶å™¨ï¼ˆåœ¨åˆ é™¤é€šç”¨å®šæ—¶å™¨å¥æŸ„ä¹‹å‰ï¼Œè¯·é€šè¿‡Â [`gptimer_disable()`](https://docs.espressif.com/projects/esp-idf/zh_CN/latest/esp32/api-reference/peripherals/gptimer.html#_CPPv415gptimer_disable16gptimer_handle_t "gptimer_disable")Â ç¦ç”¨å®šæ—¶å™¨ï¼Œæˆ–è€…é€šè¿‡Â [`gptimer_enable()`](https://docs.espressif.com/projects/esp-idf/zh_CN/latest/esp32/api-reference/peripherals/gptimer.html#_CPPv414gptimer_enable16gptimer_handle_t "gptimer_enable")Â ç¡®è®¤å®šæ—¶å™¨å°šæœªä½¿èƒ½ã€‚ï¼‰

åˆå§‹åŒ–ç¤ºä¾‹ï¼š**åˆ›å»ºåˆ†è¾¨ç‡ä¸º 1 MHz çš„é€šç”¨å®šæ—¶å™¨å¥æŸ„**

``` c
gptimer_handle_t gptimer = NULL;
gptimer_config_t timer_config = {
    .clk_src = GPTIMER_CLK_SRC_DEFAULT,
    .direction = GPTIMER_COUNT_UP,
    .resolution_hz = 1 * 1000 * 1000, // 1MHz, 1 tick = 1us
};
ESP_ERROR_CHECK(gptimer_new_timer(&timer_config, &gptimer));
```

#### 2ã€[å®šæ—¶å™¨è®¾ç½®å’Œè·å–è®¡æ•°å€¼](https://docs.espressif.com/projects/esp-idf/zh_CN/latest/esp32/api-reference/peripherals/gptimer.html#set-and-get-count-value)

åˆ›å»ºé€šç”¨å®šæ—¶å™¨æ—¶ï¼Œå†…éƒ¨è®¡æ•°å™¨å°†é»˜è®¤é‡ç½®ä¸ºé›¶ã€‚è®¡æ•°å€¼å¯ä»¥é€šè¿‡Â [`gptimer_set_raw_count()`](https://docs.espressif.com/projects/esp-idf/zh_CN/latest/esp32/api-reference/peripherals/gptimer.html#_CPPv421gptimer_set_raw_count16gptimer_handle_t8uint64_t "gptimer_set_raw_count")Â å¼‚æ­¥æ›´æ–°ã€‚æœ€å¤§è®¡æ•°å€¼å–å†³äºç¡¬ä»¶å®šæ—¶å™¨çš„ä½å®½ï¼Œè¿™ä¹Ÿä¼šåœ¨ SOC å®Â [`SOC_TIMER_GROUP_COUNTER_BIT_WIDTH`](https://docs.espressif.com/projects/esp-idf/zh_CN/latest/esp32/api-reference/system/soc_caps.html#c.SOC_TIMER_GROUP_COUNTER_BIT_WIDTH "SOC_TIMER_GROUP_COUNTER_BIT_WIDTH")Â ä¸­æœ‰æ‰€åæ˜ ã€‚å½“æ›´æ–°æ´»åŠ¨å®šæ—¶å™¨çš„åŸå§‹è®¡æ•°å€¼æ—¶ï¼Œå®šæ—¶å™¨å°†ç«‹å³ä»æ–°å€¼å¼€å§‹è®¡æ•°ã€‚

è®¡æ•°å€¼å¯ä»¥éšæ—¶é€šè¿‡Â [`gptimer_get_raw_count()`](https://docs.espressif.com/projects/esp-idf/zh_CN/latest/esp32/api-reference/peripherals/gptimer.html#_CPPv421gptimer_get_raw_count16gptimer_handle_tP8uint64_t "gptimer_get_raw_count")Â è·å–ã€‚

#### 3ã€[è®¾ç½®è­¦æŠ¥åŠ¨ä½œ](https://docs.espressif.com/projects/esp-idf/zh_CN/latest/esp32/api-reference/peripherals/gptimer.html#set-up-alarm-action)

å¯¹äºå¤§å¤šæ•°é€šç”¨å®šæ—¶å™¨ä½¿ç”¨åœºæ™¯è€Œè¨€ï¼Œåº”åœ¨å¯åŠ¨å®šæ—¶å™¨ä¹‹å‰è®¾ç½®è­¦æŠ¥åŠ¨ä½œï¼Œä½†ä¸åŒ…æ‹¬ç®€å•çš„æŒ‚é’Ÿåœºæ™¯ï¼Œè¯¥åœºæ™¯ä»…éœ€è‡ªç”±è¿è¡Œçš„å®šæ—¶å™¨ã€‚è®¾ç½®è­¦æŠ¥åŠ¨ä½œï¼Œéœ€è¦æ ¹æ®å¦‚ä½•ä½¿ç”¨è­¦æŠ¥äº‹ä»¶æ¥é…ç½®Â [`gptimer_alarm_config_t`](https://docs.espressif.com/projects/esp-idf/zh_CN/latest/esp32/api-reference/peripherals/gptimer.html#_CPPv422gptimer_alarm_config_t "gptimer_alarm_config_t")Â çš„ä¸åŒå‚æ•°ï¼š

- [`gptimer_alarm_config_t::alarm_count`](https://docs.espressif.com/projects/esp-idf/zh_CN/latest/esp32/api-reference/peripherals/gptimer.html#_CPPv4N22gptimer_alarm_config_t11alarm_countE "gptimer_alarm_config_t::alarm_count")Â è®¾ç½®è§¦å‘è­¦æŠ¥äº‹ä»¶çš„ç›®æ ‡è®¡æ•°å€¼ã€‚è®¾ç½®è­¦æŠ¥å€¼æ—¶è¿˜éœ€è€ƒè™‘è®¡æ•°æ–¹å‘ã€‚å°¤å…¶æ˜¯å½“Â [`gptimer_alarm_config_t::auto_reload_on_alarm`](https://docs.espressif.com/projects/esp-idf/zh_CN/latest/esp32/api-reference/peripherals/gptimer.html#_CPPv4N22gptimer_alarm_config_t20auto_reload_on_alarmE "gptimer_alarm_config_t::auto_reload_on_alarm")Â ä¸º true æ—¶ï¼Œ[`gptimer_alarm_config_t::alarm_count`](https://docs.espressif.com/projects/esp-idf/zh_CN/latest/esp32/api-reference/peripherals/gptimer.html#_CPPv4N22gptimer_alarm_config_t11alarm_countE "gptimer_alarm_config_t::alarm_count")Â å’ŒÂ [`gptimer_alarm_config_t::reload_count`](https://docs.espressif.com/projects/esp-idf/zh_CN/latest/esp32/api-reference/peripherals/gptimer.html#_CPPv4N22gptimer_alarm_config_t12reload_countE "gptimer_alarm_config_t::reload_count")Â ä¸èƒ½è®¾ç½®ä¸ºç›¸åŒçš„å€¼ï¼Œå› ä¸ºè­¦æŠ¥å€¼å’Œé‡è½½å€¼ç›¸åŒæ—¶æ²¡æœ‰æ„ä¹‰ã€‚
- [`gptimer_alarm_config_t::reload_count`](https://docs.espressif.com/projects/esp-idf/zh_CN/latest/esp32/api-reference/peripherals/gptimer.html#_CPPv4N22gptimer_alarm_config_t12reload_countE "gptimer_alarm_config_t::reload_count")Â ä»£è¡¨è­¦æŠ¥äº‹ä»¶å‘ç”Ÿæ—¶è¦é‡è½½çš„è®¡æ•°å€¼ã€‚æ­¤é…ç½®ä»…åœ¨Â [`gptimer_alarm_config_t::auto_reload_on_alarm`](https://docs.espressif.com/projects/esp-idf/zh_CN/latest/esp32/api-reference/peripherals/gptimer.html#_CPPv4N22gptimer_alarm_config_t20auto_reload_on_alarmE "gptimer_alarm_config_t::auto_reload_on_alarm")Â è®¾ç½®ä¸º true æ—¶ç”Ÿæ•ˆã€‚
- [`gptimer_alarm_config_t::auto_reload_on_alarm`](https://docs.espressif.com/projects/esp-idf/zh_CN/latest/esp32/api-reference/peripherals/gptimer.html#_CPPv4N22gptimer_alarm_config_t20auto_reload_on_alarmE "gptimer_alarm_config_t::auto_reload_on_alarm")Â æ ‡å¿—è®¾ç½®æ˜¯å¦ä½¿èƒ½è‡ªåŠ¨é‡è½½åŠŸèƒ½ã€‚å¦‚æœä½¿èƒ½ï¼Œç¡¬ä»¶å®šæ—¶å™¨å°†åœ¨è­¦æŠ¥äº‹ä»¶å‘ç”Ÿæ—¶ç«‹å³å°†Â [`gptimer_alarm_config_t::reload_count`](https://docs.espressif.com/projects/esp-idf/zh_CN/latest/esp32/api-reference/peripherals/gptimer.html#_CPPv4N22gptimer_alarm_config_t12reload_countE "gptimer_alarm_config_t::reload_count")Â çš„å€¼é‡è½½åˆ°è®¡æ•°å™¨ä¸­ã€‚

è¦ä½¿è­¦æŠ¥é…ç½®ç”Ÿæ•ˆï¼Œéœ€è¦è°ƒç”¨Â [`gptimer_set_alarm_action()`](https://docs.espressif.com/projects/esp-idf/zh_CN/latest/esp32/api-reference/peripherals/gptimer.html#_CPPv424gptimer_set_alarm_action16gptimer_handle_tPK22gptimer_alarm_config_t "gptimer_set_alarm_action")ã€‚ç‰¹åˆ«æ˜¯å½“Â [`gptimer_alarm_config_t`](https://docs.espressif.com/projects/esp-idf/zh_CN/latest/esp32/api-reference/peripherals/gptimer.html#_CPPv422gptimer_alarm_config_t "gptimer_alarm_config_t")Â è®¾ç½®ä¸ºÂ `NULL`Â æ—¶ï¼ŒæŠ¥è­¦åŠŸèƒ½å°†è¢«ç¦ç”¨ã€‚
 

#### 4ã€[æ³¨å†Œäº‹ä»¶å›è°ƒå‡½æ•°](https://docs.espressif.com/projects/esp-idf/zh_CN/latest/esp32/api-reference/peripherals/gptimer.html#gptimer-register-event-callbacks)

å®šæ—¶å™¨å¯åŠ¨åï¼Œå¯åŠ¨æ€äº§ç”Ÿç‰¹å®šäº‹ä»¶ï¼ˆå¦‚â€œè­¦æŠ¥äº‹ä»¶â€ï¼‰ã€‚å¦‚éœ€åœ¨äº‹ä»¶å‘ç”Ÿæ—¶è°ƒç”¨æŸäº›å‡½æ•°ï¼Œè¯·é€šè¿‡Â [`gptimer_register_event_callbacks()`](https://docs.espressif.com/projects/esp-idf/zh_CN/latest/esp32/api-reference/peripherals/gptimer.html#_CPPv432gptimer_register_event_callbacks16gptimer_handle_tPK25gptimer_event_callbacks_tPv "gptimer_register_event_callbacks")Â å°†å‡½æ•°æŒ‚è½½åˆ°ä¸­æ–­æœåŠ¡ä¾‹ç¨‹ (ISR)ã€‚[`gptimer_event_callbacks_t`](https://docs.espressif.com/projects/esp-idf/zh_CN/latest/esp32/api-reference/peripherals/gptimer.html#_CPPv425gptimer_event_callbacks_t "gptimer_event_callbacks_t")Â ä¸­åˆ—å‡ºäº†æ‰€æœ‰æ”¯æŒçš„äº‹ä»¶å›è°ƒå‡½æ•°ï¼š

- [`gptimer_event_callbacks_t::on_alarm`](https://docs.espressif.com/projects/esp-idf/zh_CN/latest/esp32/api-reference/peripherals/gptimer.html#_CPPv4N25gptimer_event_callbacks_t8on_alarmE "gptimer_event_callbacks_t::on_alarm")Â è®¾ç½®è­¦æŠ¥äº‹ä»¶çš„å›è°ƒå‡½æ•°ã€‚ç”±äºæ­¤å‡½æ•°åœ¨ ISR ä¸Šä¸‹æ–‡ä¸­è°ƒç”¨ï¼Œå¿…é¡»ç¡®ä¿è¯¥å‡½æ•°ä¸ä¼šè¯•å›¾é˜»å¡ï¼ˆä¾‹å¦‚ï¼Œç¡®ä¿ä»…ä»å‡½æ•°å†…è°ƒç”¨å…·æœ‰Â `ISR`Â åç¼€çš„ FreeRTOS APIï¼‰ã€‚å‡½æ•°åŸå‹åœ¨Â [`gptimer_alarm_cb_t`](https://docs.espressif.com/projects/esp-idf/zh_CN/latest/esp32/api-reference/peripherals/gptimer.html#_CPPv418gptimer_alarm_cb_t "gptimer_alarm_cb_t")Â ä¸­æœ‰æ‰€å£°æ˜ã€‚

æ­¤åŠŸèƒ½å°†ä¸ºå®šæ—¶å™¨å»¶è¿Ÿå®‰è£…ä¸­æ–­æœåŠ¡ï¼Œä½†ä¸ä½¿èƒ½ä¸­æ–­æœåŠ¡ã€‚æ‰€ä»¥ï¼Œè¯·åœ¨Â [`gptimer_enable()`](https://docs.espressif.com/projects/esp-idf/zh_CN/latest/esp32/api-reference/peripherals/gptimer.html#_CPPv414gptimer_enable16gptimer_handle_t "gptimer_enable")Â ä¹‹å‰è°ƒç”¨è¿™ä¸€å‡½æ•°ï¼Œå¦åˆ™å°†è¿”å›Â [`ESP_ERR_INVALID_STATE`](https://docs.espressif.com/projects/esp-idf/zh_CN/latest/esp32/api-reference/system/esp_err.html#c.ESP_ERR_INVALID_STATE "ESP_ERR_INVALID_STATE")Â é”™è¯¯ã€‚äº†è§£è¯¦ç»†ä¿¡æ¯ï¼Œè¯·æŸ¥çœ‹ç« èŠ‚Â [ä½¿èƒ½å’Œç¦ç”¨å®šæ—¶å™¨](https://docs.espressif.com/projects/esp-idf/zh_CN/latest/esp32/api-reference/peripherals/gptimer.html#enable-and-disable-timer)ã€‚

#### 5ã€[ä½¿èƒ½å’Œç¦ç”¨å®šæ—¶å™¨](https://docs.espressif.com/projects/esp-idf/zh_CN/latest/esp32/api-reference/peripherals/gptimer.html#enable-and-disable-timer)

åœ¨å¯¹å®šæ—¶å™¨è¿›è¡Œ IO æ§åˆ¶ä¹‹å‰ï¼Œéœ€è¦å…ˆè°ƒç”¨Â [`gptimer_enable()`](https://docs.espressif.com/projects/esp-idf/zh_CN/latest/esp32/api-reference/peripherals/gptimer.html#_CPPv414gptimer_enable16gptimer_handle_t "gptimer_enable")Â ä½¿èƒ½å®šæ—¶å™¨ã€‚æ­¤å‡½æ•°åŠŸèƒ½å¦‚ä¸‹ï¼š
- æ­¤å‡½æ•°å°†æŠŠå®šæ—¶å™¨é©±åŠ¨ç¨‹åºçš„çŠ¶æ€ä»Â **init**Â åˆ‡æ¢ä¸ºÂ **enable**ã€‚
- å¦‚æœÂ [`gptimer_register_event_callbacks()`](https://docs.espressif.com/projects/esp-idf/zh_CN/latest/esp32/api-reference/peripherals/gptimer.html#_CPPv432gptimer_register_event_callbacks16gptimer_handle_tPK25gptimer_event_callbacks_tPv "gptimer_register_event_callbacks")Â å·²ç»å»¶è¿Ÿå®‰è£…ä¸­æ–­æœåŠ¡ï¼Œæ­¤å‡½æ•°å°†ä½¿èƒ½ä¸­æ–­æœåŠ¡ã€‚

è°ƒç”¨Â [`gptimer_disable()`](https://docs.espressif.com/projects/esp-idf/zh_CN/latest/esp32/api-reference/peripherals/gptimer.html#_CPPv415gptimer_disable16gptimer_handle_t "gptimer_disable")Â ä¼šè¿›è¡Œç›¸åçš„æ“ä½œï¼Œå³å°†å®šæ—¶å™¨é©±åŠ¨ç¨‹åºæ¢å¤åˆ°Â **init**Â çŠ¶æ€ï¼Œç¦ç”¨ä¸­æ–­æœåŠ¡å¹¶é‡Šæ”¾ç”µæºç®¡ç†é”ã€‚

#### 6ã€å¯åŠ¨å’Œåœæ­¢å®šæ—¶å™¨

å¯åŠ¨å’Œåœæ­¢æ˜¯å®šæ—¶å™¨çš„åŸºæœ¬ IO æ“ä½œã€‚è°ƒç”¨Â [`gptimer_start()`](https://docs.espressif.com/projects/esp-idf/zh_CN/latest/esp32/api-reference/peripherals/gptimer.html#_CPPv413gptimer_start16gptimer_handle_t "gptimer_start")Â å¯ä»¥ä½¿å†…éƒ¨è®¡æ•°å™¨å¼€å§‹å·¥ä½œï¼Œè€ŒÂ [`gptimer_stop()`](https://docs.espressif.com/projects/esp-idf/zh_CN/latest/esp32/api-reference/peripherals/gptimer.html#_CPPv412gptimer_stop16gptimer_handle_t "gptimer_stop")Â å¯ä»¥ä½¿è®¡æ•°å™¨åœæ­¢å·¥ä½œã€‚ä¸‹æ–‡è¯´æ˜äº†å¦‚ä½•åœ¨å­˜åœ¨æˆ–ä¸å­˜åœ¨è­¦æŠ¥äº‹ä»¶çš„æƒ…å†µä¸‹å¯åŠ¨å®šæ—¶å™¨ã€‚

è°ƒç”¨Â [`gptimer_start()`](https://docs.espressif.com/projects/esp-idf/zh_CN/latest/esp32/api-reference/peripherals/gptimer.html#_CPPv413gptimer_start16gptimer_handle_t "gptimer_start")Â å°†ä½¿é©±åŠ¨ç¨‹åºçŠ¶æ€ä» enable è½¬æ¢ä¸º run, åä¹‹äº¦ç„¶ã€‚æ³¨æ„ç¡®ä¿ start å’Œ stop å‡½æ•°æˆå¯¹ä½¿ç”¨ï¼Œå¦åˆ™ï¼Œå‡½æ•°å¯èƒ½è¿”å›Â [`ESP_ERR_INVALID_STATE`](https://docs.espressif.com/projects/esp-idf/zh_CN/latest/esp32/api-reference/system/esp_err.html#c.ESP_ERR_INVALID_STATE "ESP_ERR_INVALID_STATE")ã€‚

## ä¸‰ã€ç¤ºä¾‹ï¼š

>å‚è€ƒï¼šhttps://github.com/espressif/esp-idf/blob/fdb7a43752633560c73ee079d512c0c13808456f/examples/peripherals/timer_group/gptimer/main/gptimer_example_main.c

``` c

#include <stdio.h>
#include "freertos/FreeRTOS.h"
#include "freertos/task.h"
#include "freertos/queue.h"
#include "driver/gptimer.h"
#include "esp_log.h"

static const char *TAG = "gptimer";

typedef struct {
    uint64_t event_count;
} example_queue_element_t;

// å®šæ—¶å™¨è­¦æŠ¥äº‹ä»¶çš„å›è°ƒå‡½æ•°(æ¡ˆä¾‹1)
// ä¸‰ä¸ªå‚æ•°:å®šæ—¶å™¨å¥æŸ„ timerã€äº‹ä»¶æ•°æ®æŒ‡é’ˆ edata å’Œç”¨æˆ·æ•°æ®æŒ‡é’ˆ user_dataã€‚
static bool IRAM_ATTR example_timer_on_alarm_cb_v1(gptimer_handle_t timer, const gptimer_alarm_event_data_t *edata, void *user_data)
{
    BaseType_t high_task_awoken = pdFALSE;
    QueueHandle_t queue = (QueueHandle_t)user_data;
    // ç«‹å³åœæ­¢è®¡æ—¶å™¨
    gptimer_stop(timer);
    // ä»äº‹ä»¶æ•°æ®ä¸­è·å–è®¡æ•°å€¼ï¼Œå¹¶å°†å…¶å­˜å‚¨åœ¨ example_queue_element_t ç»“æ„ä½“å˜é‡ ele çš„ event_count å­—æ®µä¸­ã€‚
    example_queue_element_t ele = {
        .event_count = edata->count_value
    };
	//ä½¿ç”¨ xQueueSendFromISR() å‡½æ•°å°† ele å˜é‡å‘é€åˆ°é˜Ÿåˆ—ä¸­
    xQueueSendFromISR(queue, &ele, &high_task_awoken);
    // return whether we need to yield at the end of ISR
    return (high_task_awoken == pdTRUE);
}

// å®šæ—¶å™¨è­¦æŠ¥äº‹ä»¶çš„å›è°ƒå‡½æ•°(æ¡ˆä¾‹2)
static bool IRAM_ATTR example_timer_on_alarm_cb_v2(gptimer_handle_t timer, const gptimer_alarm_event_data_t *edata, void *user_data)
{
    BaseType_t high_task_awoken = pdFALSE;
    QueueHandle_t queue = (QueueHandle_t)user_data;
    // Retrieve count value and send to queue
    example_queue_element_t ele = {
        .event_count = edata->count_value
    };
    xQueueSendFromISR(queue, &ele, &high_task_awoken);
    // return whether we need to yield at the end of ISR
    return (high_task_awoken == pdTRUE);
}

// å®šæ—¶å™¨è­¦æŠ¥äº‹ä»¶çš„å›è°ƒå‡½æ•°(æ¡ˆä¾‹3:åŠ¨æ€æ›´æ–°æŠ¥è­¦å€¼)
static bool IRAM_ATTR example_timer_on_alarm_cb_v3(gptimer_handle_t timer, const gptimer_alarm_event_data_t *edata, void *user_data)
{
    BaseType_t high_task_awoken = pdFALSE;
    QueueHandle_t queue = (QueueHandle_t)user_data;
    // Retrieve count value and send to queue
    example_queue_element_t ele = {
        .event_count = edata->count_value
    };
    xQueueSendFromISR(queue, &ele, &high_task_awoken);
    // reconfigure alarm value
    gptimer_alarm_config_t alarm_config = {
        .alarm_count = edata->alarm_value + 1000000, // alarm in next 1s
    };
    gptimer_set_alarm_action(timer, &alarm_config);
    // return whether we need to yield at the end of ISR
    return (high_task_awoken == pdTRUE);
}

void app_main(void)
{
	// å®šä¹‰ä¸€ä¸ª example_queue_element_t ç±»å‹çš„å˜é‡ ele
    example_queue_element_t ele;
	//åˆ›å»ºäº†ä¸€ä¸ªé•¿åº¦ä¸º 10ï¼Œæ¯ä¸ªå…ƒç´ å¤§å°ä¸º example_queue_element_t ç±»å‹çš„é˜Ÿåˆ—ï¼Œå¹¶å°†å…¶èµ‹å€¼ç»™ queue å˜é‡ã€‚
    QueueHandle_t queue = xQueueCreate(10, sizeof(example_queue_element_t));
    if (!queue) {
        ESP_LOGE(TAG, "åˆ›å»ºé˜Ÿåˆ—å¤±è´¥");
        return;
    }

	// åˆå§‹åŒ–å®šæ—¶å™¨
    ESP_LOGI(TAG, "åˆ›å»ºåˆ†è¾¨ç‡ä¸º 1 MHz çš„é€šç”¨å®šæ—¶å™¨å¥æŸ„");
    gptimer_handle_t gptimer = NULL;
    gptimer_config_t timer_config = {
        .clk_src = GPTIMER_CLK_SRC_DEFAULT,
        .direction = GPTIMER_COUNT_UP,
        .resolution_hz = 1000000, // 1MHz, 1 tick=1us
    };
    ESP_ERROR_CHECK(gptimer_new_timer(&timer_config, &gptimer));

	// æ³¨å†Œå®šæ—¶å™¨äº‹ä»¶å›è°ƒå‡½æ•°(è­¦æŠ¥äº‹ä»¶çš„å›è°ƒå‡½æ•°)
    gptimer_event_callbacks_t cbs = {
        .on_alarm = example_timer_on_alarm_cb_v1,
    };
    ESP_ERROR_CHECK(gptimer_register_event_callbacks(gptimer, &cbs, queue));

    // ä½¿èƒ½å®šæ—¶å™¨
    ESP_LOGI(TAG, "Enable timer");
    ESP_ERROR_CHECK(gptimer_enable(gptimer));

 	// è®¾ç½®å®šæ—¶å™¨çš„å‘¨æœŸä¸º 1s(è§¦å‘è­¦æŠ¥äº‹ä»¶çš„ç›®æ ‡è®¡æ•°å€¼)
    ESP_LOGI(TAG, "Start timer, stop it at alarm event");
    gptimer_alarm_config_t alarm_config1 = {
        .alarm_count = 1000000, // period = 1s
    };
	// è®¾ç½®å®šæ—¶å™¨çš„æŠ¥è­¦äº‹ä»¶
    ESP_ERROR_CHECK(gptimer_set_alarm_action(gptimer, &alarm_config1));
	// å¯åŠ¨å®šæ—¶å™¨
    ESP_ERROR_CHECK(gptimer_start(gptimer));

    // ç­‰å¾…å®šæ—¶å™¨æŠ¥è­¦äº‹ä»¶(ä»é˜Ÿåˆ—ä¸­æ¥æ”¶æ•°æ®,æ¥æ”¶åˆ°çš„æ•°æ®å°†ä¼šå­˜å‚¨åœ¨ &ele ä¸­)
    if (xQueueReceive(queue, &ele, pdMS_TO_TICKS(2000))) {
        ESP_LOGI(TAG, "Timer stopped, count=%llu", ele.event_count);
    } else {
        ESP_LOGW(TAG, "Missed one count event");
    }

	// è®¾ç½®å®šæ—¶å™¨çš„è®¡æ•°å€¼(å¼‚æ­¥æ›´æ–°)
    ESP_LOGI(TAG, "Set count value");
    ESP_ERROR_CHECK(gptimer_set_raw_count(gptimer, 100));
    ESP_LOGI(TAG, "Get count value");

	// è·å–å®šæ—¶å™¨çš„è®¡æ•°å€¼
    uint64_t count;
    ESP_ERROR_CHECK(gptimer_get_raw_count(gptimer, &count));
    ESP_LOGI(TAG, "Timer count value=%llu", count);

    //--------------------------------------------------------------------//
	ESP_LOGW(TAG, "æ¡ˆä¾‹1ç»“æŸ,æ¡ˆä¾‹2å¼€å§‹");
	//--------------------------------------------------------------------//

    // åœ¨æ›´æ–°æŠ¥è­¦å›è°ƒä¹‹å‰ï¼Œæˆ‘ä»¬åº”è¯¥ç¡®ä¿è®¡æ—¶å™¨æ²¡æœ‰å¤„äºå¯ç”¨çŠ¶æ€
    ESP_LOGI(TAG, "Disable timer");
    ESP_ERROR_CHECK(gptimer_disable(gptimer));
    // è®¾ç½®ä¸€ä¸ªæ–°çš„å›è°ƒå‡½æ•°
    cbs.on_alarm = example_timer_on_alarm_cb_v2;
    ESP_ERROR_CHECK(gptimer_register_event_callbacks(gptimer, &cbs, queue));
    ESP_LOGI(TAG, "Enable timer");
    ESP_ERROR_CHECK(gptimer_enable(gptimer));

    // é‡æ–°è®¾ç½®æŠ¥è­¦æ¡ä»¶
    ESP_LOGI(TAG, "Start timer, auto-reload at alarm event");
    gptimer_alarm_config_t alarm_config2 = {
        .reload_count = 0,
        .alarm_count = 1000000, // period = 1s
        .flags.auto_reload_on_alarm = true, //æŠ¥è­¦äº‹ä»¶å‘ç”Ÿåç«‹å³é€šè¿‡ç¡¬ä»¶é‡æ–°åŠ è½½è®¡æ•°å€¼
    };
	// è®¾ç½®å®šæ—¶å™¨çš„æŠ¥è­¦äº‹ä»¶
    ESP_ERROR_CHECK(gptimer_set_alarm_action(gptimer, &alarm_config2));
    ESP_ERROR_CHECK(gptimer_start(gptimer));

 	// å¾ªç¯æ¬¡æ•°ä¸º4æ¬¡ã€‚åœ¨æ¯æ¬¡å¾ªç¯ä¸­ï¼Œé€šè¿‡ xQueueReceive() å‡½æ•°ä»é˜Ÿåˆ—ä¸­æ¥æ”¶æ•°æ®ï¼Œå¹¶ç­‰å¾…æœ€å¤š2ç§’ã€‚å¦‚æœæˆåŠŸæ¥æ”¶åˆ°æ•°æ®ï¼Œåˆ™æ‰“å°å®šæ—¶å™¨é‡æ–°åŠ è½½çš„æ¶ˆæ¯
    int record = 4;
    while (record) {
        if (xQueueReceive(queue, &ele, pdMS_TO_TICKS(2000))) {
            ESP_LOGI(TAG, "Timer reloaded, count=%llu", ele.event_count);
            record--;
        } else {
            ESP_LOGW(TAG, "Missed one count event");
        }
    }
    ESP_LOGI(TAG, "Stop timer");
    ESP_ERROR_CHECK(gptimer_stop(gptimer));

    ESP_LOGI(TAG, "Disable timer");
    ESP_ERROR_CHECK(gptimer_disable(gptimer));

    //--------------------------------------------------------------------//
	ESP_LOGW(TAG, "æ¡ˆä¾‹2ç»“æŸ,æ¡ˆä¾‹3å¼€å§‹");
	//--------------------------------------------------------------------//
	// æ¡ˆä¾‹3åŠ¨æ€æ›´æ–°æŠ¥è­¦å€¼
    cbs.on_alarm = example_timer_on_alarm_cb_v3;
    ESP_ERROR_CHECK(gptimer_register_event_callbacks(gptimer, &cbs, queue));
    ESP_LOGI(TAG, "Enable timer");
    ESP_ERROR_CHECK(gptimer_enable(gptimer));

    ESP_LOGI(TAG, "Start timer, update alarm value dynamically");
    gptimer_alarm_config_t alarm_config3 = {
        .alarm_count = 1000000, // period = 1s
    };
    ESP_ERROR_CHECK(gptimer_set_alarm_action(gptimer, &alarm_config3));
    ESP_ERROR_CHECK(gptimer_start(gptimer));
    record = 4;
    while (record) {
        if (xQueueReceive(queue, &ele, pdMS_TO_TICKS(2000))) {
            ESP_LOGI(TAG, "Timer alarmed, count=%llu", ele.event_count);
            record--;
        } else {
            ESP_LOGW(TAG, "Missed one count event");
        }
    }

    ESP_LOGI(TAG, "Stop timer");
    ESP_ERROR_CHECK(gptimer_stop(gptimer));
    ESP_LOGI(TAG, "Disable timer");
    ESP_ERROR_CHECK(gptimer_disable(gptimer));
    ESP_LOGI(TAG, "Delete timer");
    ESP_ERROR_CHECK(gptimer_del_timer(gptimer));

    vQueueDelete(queue);
}

```

ä¸Šé¢çš„ç¤ºä¾‹ç¨‹åºï¼ŒåŒ…å«äº†ä¸‰ä¸ªæ¡ˆä¾‹ï¼š

1. æ¡ˆä¾‹1ï¼šå®šæ—¶å™¨è§¦å‘è­¦æŠ¥äº‹ä»¶åç«‹å³åœæ­¢è®¡æ—¶å™¨ï¼Œå¹¶å°†äº‹ä»¶æ•°æ®å‘é€åˆ°é˜Ÿåˆ—ä¸­ã€‚
2. æ¡ˆä¾‹2ï¼šå®šæ—¶å™¨è§¦å‘è­¦æŠ¥äº‹ä»¶åè‡ªåŠ¨é‡æ–°åŠ è½½è®¡æ•°å€¼ï¼Œå¹¶å°†äº‹ä»¶æ•°æ®å‘é€åˆ°é˜Ÿåˆ—ä¸­ã€‚
3. æ¡ˆä¾‹3ï¼šå®šæ—¶å™¨è§¦å‘è­¦æŠ¥äº‹ä»¶ååŠ¨æ€æ›´æ–°æŠ¥è­¦å€¼ï¼Œå¹¶å°†äº‹ä»¶æ•°æ®å‘é€åˆ°é˜Ÿåˆ—ä¸­ã€‚

åœ¨æ¯ä¸ªæ¡ˆä¾‹ä¸­ï¼Œç¨‹åºåˆå§‹åŒ– gptimerï¼Œæ³¨å†Œç›¸åº”çš„å®šæ—¶å™¨äº‹ä»¶å›è°ƒå‡½æ•°ï¼Œå¯åŠ¨å®šæ—¶å™¨å¹¶è®¾ç½®æŠ¥è­¦äº‹ä»¶ï¼Œç„¶åé€šè¿‡é˜Ÿåˆ—æ¥æ”¶æ•°æ®å¹¶è¿›è¡Œç›¸åº”çš„å¤„ç†ã€‚

æ•ˆæœï¼š

![](attachments/20240304172313.png)
# å‚è€ƒé“¾æ¥
1. https://docs.espressif.com/projects/esp-idf/zh_CN/latest/esp32/api-reference/peripherals/gptimer.html#id26