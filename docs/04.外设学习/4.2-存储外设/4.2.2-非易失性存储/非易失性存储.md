

<div STYLE="page-break-after: always;"></div>

# ESP32å­˜å‚¨-éæ˜“å¤±æ€§å­˜å‚¨ (NVS)

> [!TIP] ğŸš€ **ESP32 å­˜å‚¨-éæ˜“å¤±æ€§å­˜å‚¨ (NVS) | ç¨³å®šæŒä¹…å­˜å‚¨è§£å†³æ–¹æ¡ˆ**  
> - ğŸ’¡ **ç¢ç¢å¿µ**ğŸ˜ï¼šæœ¬èŠ‚å°†ä»‹ç» ESP32 çš„éæ˜“å¤±æ€§å­˜å‚¨ (NVS)ï¼Œè®©ä½ è½»æ¾ä¿å­˜é…ç½®ä¿¡æ¯åŠå…¶ä»–æ•°æ®ï¼Œå³ä½¿è®¾å¤‡æ–­ç”µä¹Ÿèƒ½ä¿æŒæ•°æ®ã€‚  
> - ğŸ“º **è§†é¢‘æ•™ç¨‹**ï¼šğŸš§ *å¼€å‘ä¸­*  
> - ğŸ’¾ **ç¤ºä¾‹ä»£ç **ï¼šğŸš§ *å¼€å‘ä¸­*

## ä¸€ã€ä»‹ç»

#### 1.1 åŸºæœ¬æ¦‚å¿µ

éæ˜“å¤±æ€§å­˜å‚¨ (NVS) åº“ä¸»è¦ç”¨äºåœ¨ flash ä¸­**å­˜å‚¨é”®å€¼æ ¼å¼çš„æ•°æ®**ã€‚

åœ¨åˆ†åŒºè¡¨ä¸€èŠ‚æˆ‘ä»¬æ‰€çœ‹åˆ°çš„åˆ†åŒºè¡¨é‡Œéƒ½æœ‰ä¸€ä¸ªnvsåˆ†åŒºï¼Œå¦‚ä¸‹ï¼ˆç¬¬ä¸€æ¡åˆ†åŒºï¼‰ï¼š
```c
# Name,   Type, SubType, Offset,  Size, Flags
nvs,      data, nvs,     0x9000,  0x4000,
otadata,  data, ota,     0xd000,  0x2000,
phy_init, data, phy,     0xf000,  0x1000,
factory,  app,  factory, 0x10000,  1M,
```

NVS åº“é€šè¿‡è°ƒç”¨Â [esp_partition](https://docs.espressif.com/projects/esp-idf/zh_CN/latest/esp32/api-reference/storage/partition.html#flash-partition-apis)Â API ä½¿ç”¨ä¸» flash çš„éƒ¨åˆ†ç©ºé—´ï¼Œå³ç±»å‹ä¸ºÂ `data`Â ä¸”å­ç±»å‹ä¸ºÂ `nvs`Â çš„æ‰€æœ‰åˆ†åŒºã€‚è¿™éƒ¨åˆ†ç©ºé—´å°±æ˜¯ç•™ç»™æˆ‘ä»¬å……å½“é”®å€¼å¯¹æ•°æ®å­˜å‚¨çš„ã€‚

>NVS æœ€é€‚åˆå­˜å‚¨ä¸€äº›è¾ƒå°çš„æ•°æ®ï¼Œè€Œéå­—ç¬¦ä¸²æˆ–äºŒè¿›åˆ¶å¤§å¯¹è±¡ (BLOB) ç­‰è¾ƒå¤§çš„æ•°æ®ã€‚å¦‚éœ€å­˜å‚¨è¾ƒå¤§çš„ BLOB æˆ–è€…å­—ç¬¦ä¸²ï¼Œè¯·è€ƒè™‘ä½¿ç”¨åŸºäºç£¨æŸå‡è¡¡åº“çš„ FAT æ–‡ä»¶ç³»ç»Ÿã€‚
>å¦‚æœNVSåˆ†åŒºè¢«æˆªæ–­ï¼Œæ¯”å¦‚æ›´æ”¹åˆ†åŒºè¡¨å¸ƒå±€çš„æ—¶å€™ï¼Œåº”è¯¥æ“¦é™¤åˆ†åŒºå†…å®¹ã€‚å¯ä»¥ä½¿ç”¨Â `idf.py erase_flash`Â å‘½ä»¤æ“¦é™¤flashä¸Šå…¨éƒ¨çš„å†…å®¹ã€‚

#### 1.2 é”®å€¼å¯¹ç»†èŠ‚

NVS çš„æ“ä½œå¯¹è±¡ä¸ºé”®å€¼å¯¹ï¼Œå…¶ä¸­é”®æ˜¯ ASCII å­—ç¬¦ä¸²ï¼Œå½“å‰æ”¯æŒæœ€å¤§é”®é•¿ä¸º 15 ä¸ªå­—ç¬¦ï¼Œå€¼å¯ä»¥ä¸ºä»¥ä¸‹å‡ ç§ç±»å‹ï¼š
æ•´æ•°å‹ï¼š uint8_tã€int8_tã€uint16_tã€int16_tã€uint32_tã€int32_tã€uint64_t å’Œ int64_tï¼›
å­—ç¬¦å‹ï¼š ä»¥ \0 ç»“å°¾çš„å­—ç¬¦ä¸²ï¼›
äºŒè¿›åˆ¶æ•°æ®ï¼š å¯å˜é•¿åº¦çš„äºŒè¿›åˆ¶æ•°æ® (BLOB)ã€‚

é”®å¿…é¡»å”¯ä¸€ã€‚ä¸ºç°æœ‰çš„é”®å†™å…¥æ–°å€¼æ—¶ï¼Œä¼šå°†æ—§çš„å€¼åŠæ•°æ®ç±»å‹æ›´æ–°ä¸ºå†™å…¥æ“ä½œæŒ‡å®šçš„å€¼å’Œæ•°æ®ç±»å‹ã€‚

è¯»å–å€¼æ—¶ä¼šæ‰§è¡Œæ•°æ®ç±»å‹æ£€æŸ¥ã€‚å¦‚æœè¯»å–æ“ä½œé¢„æœŸçš„æ•°æ®ç±»å‹ä¸å¯¹åº”é”®çš„æ•°æ®ç±»å‹ä¸åŒ¹é…ï¼Œåˆ™è¿”å›é”™è¯¯ã€‚

#### 1.3 å‘½åç©ºé—´

ä¸ºäº†å‡å°‘ä¸åŒç»„ä»¶ä¹‹é—´é”®åçš„æ½œåœ¨å†²çªï¼ŒNVS å°†æ¯ä¸ªé”®å€¼å¯¹åˆ†é…ç»™ä¸€ä¸ªå‘½åç©ºé—´ã€‚å‘½åç©ºé—´çš„å‘½åè§„åˆ™éµå¾ªé”®åçš„å‘½åè§„åˆ™ï¼Œä¾‹å¦‚ï¼Œæœ€å¤šå¯å  15 ä¸ªå­—ç¬¦ã€‚æ­¤å¤–ï¼Œå•ä¸ª NVS åˆ†åŒºæœ€å¤šåªèƒ½å®¹çº³ 254 ä¸ªä¸åŒçš„å‘½åç©ºé—´ã€‚å‘½åç©ºé—´çš„åç§°åœ¨è°ƒç”¨Â [`nvs_open()`](https://docs.espressif.com/projects/esp-idf/zh_CN/latest/esp32/api-reference/storage/nvs_flash.html#_CPPv48nvs_openPKc15nvs_open_mode_tP12nvs_handle_t "nvs_open")Â æˆ–Â [`nvs_open_from_partition`](https://docs.espressif.com/projects/esp-idf/zh_CN/latest/esp32/api-reference/storage/nvs_flash.html#_CPPv423nvs_open_from_partitionPKcPKc15nvs_open_mode_tP12nvs_handle_t "nvs_open_from_partition")Â ä¸­æŒ‡å®šï¼Œè°ƒç”¨åå°†è¿”å›ä¸€ä¸ªä¸é€æ˜å¥æŸ„ï¼Œç”¨äºåç»­è°ƒç”¨Â `nvs_get_*`ã€`nvs_set_*`Â å’ŒÂ `nvs_commit`Â å‡½æ•°ã€‚è¿™æ ·ï¼Œä¸€ä¸ªå¥æŸ„å…³è”ä¸€ä¸ªå‘½åç©ºé—´ï¼Œé”®åä¾¿ä¸ä¼šä¸å…¶ä»–å‘½åç©ºé—´ä¸­ç›¸åŒé”®åå†²çªã€‚

## äºŒã€ä½¿ç”¨

NVS ç¨‹åºæ¥å£ä½äº `esp-idf/components/nvs_flash/include/nvs_flash.h`

#### 2.1 åˆå§‹åŒ–

ä½¿ç”¨å‡½æ•°`nvs_flash_init()`ï¼Œåˆå§‹åŒ–é»˜è®¤NVSåˆ†åŒºï¼ˆæ— å‚æ•°ï¼‰

> `nvs_flash_erase()`æ“¦é™¤é»˜è®¤NVSåˆ†åŒºï¼ˆæ ‡ç­¾ä¸ºâ€œNVSâ€çš„åˆ†åŒºï¼‰çš„æ‰€æœ‰å†…å®¹ã€‚

ç¤ºä¾‹ï¼š
``` c
// Initialize NVS
esp_err_t err = nvs_flash_init();
if (err == ESP_ERR_NVS_NO_FREE_PAGES || err == ESP_ERR_NVS_NEW_VERSION_FOUND) {
	// NVS partition was truncated and needs to be erased
	// Retry nvs_flash_init
	ESP_ERROR_CHECK(nvs_flash_erase());
	err = nvs_flash_init();
}
ESP_ERROR_CHECK( err );
```
#### 2.2 æ‰“å¼€å­˜å‚¨ç©ºé—´

ä½¿ç”¨å‡½æ•°`esp_err_t nvs_open(const char *namespace_name, nvs_open_mode_t open_mode, nvs_handle_t *out_handle)`ä»é»˜è®¤NVSåˆ†åŒºæ‰“å¼€å…·æœ‰ç»™å®šå‘½åç©ºé—´çš„éæ˜“å¤±æ€§å­˜å‚¨ã€‚

å‚æ•°ï¼š
- [in] name:å‘½åç©ºé—´åç§°ã€‚æœ€å¤§é•¿åº¦ä¸º(NVS_KEY_NAME_MAX_SIZE-1)ä¸ªå­—ç¬¦ã€‚ä¸åº”è¯¥æ˜¯ç©ºçš„ã€‚
- [in] open_mode : NVS_READWRITE æˆ–NVS_READONLYã€‚å¦‚æœæ˜¯NVS_READONLYï¼Œå°†æ‰“å¼€ä¸€ä¸ªåªè¯»å¥æŸ„ã€‚æ­¤å¥æŸ„çš„æ‰€æœ‰å†™å…¥è¯·æ±‚éƒ½å°†è¢«æ‹’ç»ã€‚
- [out] out_handle:å¦‚æœæˆåŠŸ(è¿”å›ç ä¸ºé›¶)ï¼Œå°†åœ¨æ­¤å‚æ•°ä¸­è¿”å›å¥æŸ„ã€‚

ç¤ºä¾‹ï¼š
```c
    nvs_handle_t my_handle;
    err = nvs_open("storage", NVS_READWRITE, &my_handle);
```


#### 2.3 è¯»å–API

åŸºæœ¬ç±»å‹ï¼š

```c
esp_err_t nvs_get_i8  (nvs_handle_t handle, const char* key, int8_t* out_value);
esp_err_t nvs_get_u8  (nvs_handle_t handle, const char* key, uint8_t* out_value);
esp_err_t nvs_get_i16 (nvs_handle_t handle, const char* key, int16_t* out_value);
esp_err_t nvs_get_u16 (nvs_handle_t handle, const char* key, uint16_t* out_value);
esp_err_t nvs_get_i32 (nvs_handle_t handle, const char* key, int32_t* out_value);
esp_err_t nvs_get_u32 (nvs_handle_t handle, const char* key, uint32_t* out_value);
esp_err_t nvs_get_i64 (nvs_handle_t handle, const char* key, int64_t* out_value);
esp_err_t nvs_get_u64 (nvs_handle_t handle, const char* key, uint64_t* out_value);
```

å…¶ä»–ç±»å‹(å¤šä¸€ä¸ªé•¿åº¦çš„å‚æ•°)ï¼š

``` c
esp_err_t nvs_get_str (nvs_handle_t handle, const char* key, char* out_value, size_t* length);
esp_err_t nvs_get_blob(nvs_handle_t handle, const char* key, void* out_value, size_t* length);

```

è¿™éƒ¨åˆ†apiï¼Œç®€å•æ˜äº†ï¼Œä¸å†æ­¤è¯¦ç»†è§£é‡Šã€‚

#### 2.4 å†™å…¥API

åŸºæœ¬ç±»å‹ï¼š

``` c
esp_err_t nvs_set_i8  (nvs_handle_t handle, const char* key, int8_t value);
esp_err_t nvs_set_u8  (nvs_handle_t handle, const char* key, uint8_t value);
esp_err_t nvs_set_i16 (nvs_handle_t handle, const char* key, int16_t value);
esp_err_t nvs_set_u16 (nvs_handle_t handle, const char* key, uint16_t value);
esp_err_t nvs_set_i32 (nvs_handle_t handle, const char* key, int32_t value);
esp_err_t nvs_set_u32 (nvs_handle_t handle, const char* key, uint32_t value);
esp_err_t nvs_set_i64 (nvs_handle_t handle, const char* key, int64_t value);
esp_err_t nvs_set_u64 (nvs_handle_t handle, const char* key, uint64_t value);
esp_err_t nvs_set_str (nvs_handle_t handle, const char* key, const char* value);
```

å…¶ä»–ç±»å‹(å¤šä¸€ä¸ªlengthçš„å‚æ•°)ï¼š
``` c
//ç”¨æ¥å­˜å‚¨å¤§äºŒè¿›åˆ¶æ•°æ®çš„å‡½æ•°ï¼ˆæ¯”å¦‚è¯´ç»“æ„ä½“ï¼‰ esp_err_t nvs_set_blob(nvs_handle_t handle, const char* key, const void* value, size_t length);
```

#### 2.5 é‡Šæ”¾èµ„æº

ä½¿ç”¨å‡½æ•°`void nvs_close(nvs_handle_t handle)`å…³é—­å­˜å‚¨å¥æŸ„å¹¶é‡Šæ”¾æ‰€æœ‰å·²åˆ†é…çš„èµ„æºã€‚
ä¸€æ—¦ä¸å†ä½¿ç”¨nvs_openæ‰“å¼€çš„æ¯ä¸ªå¥æŸ„ï¼Œå°±åº”è¯¥ä¸ºè¯¥å¥æŸ„è°ƒç”¨æ­¤å‡½æ•°ã€‚å…³é—­å¥æŸ„å¯èƒ½ä¸ä¼šè‡ªåŠ¨å°†æ›´æ”¹å†™å…¥éæ˜“å¤±æ€§å­˜å‚¨å™¨ã€‚è¿™å¿…é¡»ä½¿ç”¨`nvs_commit()`å‡½æ•°æ˜¾å¼å®Œæˆã€‚ä¸€æ—¦å¯¹å¥æŸ„è°ƒç”¨äº†æ­¤å‡½æ•°ï¼Œå°±ä¸åº”å†ä½¿ç”¨è¯¥å¥æŸ„ã€‚

## ä¸‰ã€æ¡ˆä¾‹

ä¸‹é¢çš„æ¡ˆä¾‹ç”¨äºåœ¨ESP32è®¾å¤‡ä¸Šå®ç°ä¸€ä¸ªç®€å•çš„é‡å¯è®¡æ•°å™¨ï¼Œå¹¶å°†é‡å¯æ¬¡æ•°å­˜å‚¨åœ¨éæ˜“å¤±æ€§å­˜å‚¨ä¸­ã€‚

```c
#include <stdio.h>
#include <inttypes.h>
#include "freertos/FreeRTOS.h"
#include "freertos/task.h"
#include "esp_system.h"
#include "nvs_flash.h"
#include "nvs.h"

void app_main(void)
{
    // Initialize NVS
    esp_err_t err = nvs_flash_init();
    if (err == ESP_ERR_NVS_NO_FREE_PAGES || err == ESP_ERR_NVS_NEW_VERSION_FOUND) {
        // NVS partition was truncated and needs to be erased
        // Retry nvs_flash_init
        ESP_ERROR_CHECK(nvs_flash_erase());
        err = nvs_flash_init();
    }
    ESP_ERROR_CHECK( err );

    // Open
    printf("\n");
    printf("Opening Non-Volatile Storage (NVS) handle... ");
    nvs_handle_t my_handle;
    err = nvs_open("storage", NVS_READWRITE, &my_handle);
    if (err != ESP_OK) {
        printf("Error (%s) opening NVS handle!\n", esp_err_to_name(err));
    } else {
        printf("Done\n");

        // Read
        printf("Reading restart counter from NVS ... ");
        int32_t restart_counter = 0; // value will default to 0, if not set yet in NVS
        err = nvs_get_i32(my_handle, "restart_counter", &restart_counter);
        switch (err) {
            case ESP_OK:
                printf("Done\n");
                printf("Restart counter = %" PRIu32 "\n", restart_counter);
                break;
            case ESP_ERR_NVS_NOT_FOUND:
                printf("The value is not initialized yet!\n");
                break;
            default :
                printf("Error (%s) reading!\n", esp_err_to_name(err));
        }

        // Write
        printf("Updating restart counter in NVS ... ");
        restart_counter++;
        err = nvs_set_i32(my_handle, "restart_counter", restart_counter);
        printf((err != ESP_OK) ? "Failed!\n" : "Done\n");

        // Commit written value.
        // After setting any values, nvs_commit() must be called to ensure changes are written
        // to flash storage. Implementations may write to storage at other times,
        // but this is not guaranteed.
        printf("Committing updates in NVS ... ");
        err = nvs_commit(my_handle);
        printf((err != ESP_OK) ? "Failed!\n" : "Done\n");

        // Close
        nvs_close(my_handle);
    }

    printf("\n");

    // Restart module
    for (int i = 10; i >= 0; i--) {
        printf("Restarting in %d seconds...\n", i);
        vTaskDelay(1000 / portTICK_PERIOD_MS);
    }
    printf("Restarting now.\n");
    fflush(stdout);
    esp_restart();
}

```

æ•ˆæœï¼šå¯ä»¥è®°å½•ä¸‹é‡å¯çš„æ¬¡æ•°ï¼Œä¸éšæ‰ç”µä¸¢å¤±ã€‚

![](attachments/1.png)

# å‚è€ƒé“¾æ¥

1. https://docs.espressif.com/projects/esp-idf/zh_CN/release-v5.2/esp32/api-reference/storage/nvs_flash.html#_CPPv48nvs_openPKc15nvs_open_mode_tP12nvs_handle_t