# ESP32å­˜å‚¨-åˆ†åŒºè¡¨å…¥é—¨

> [!TIP] ğŸš€ ESP32 å­˜å‚¨-åˆ†åŒºè¡¨å…¥é—¨ | é«˜æ•ˆç®¡ç†è®¾å¤‡å­˜å‚¨ç©ºé—´  
> - ğŸ’¡ **ç¢ç¢å¿µ**ğŸ˜ï¼šæœ¬èŠ‚å°†ä»‹ç» ESP32 çš„åˆ†åŒºè¡¨ï¼Œå¸®åŠ©ä½ åˆç†åˆ†é…å­˜å‚¨ç©ºé—´ï¼Œæé«˜ç³»ç»Ÿçš„å­˜å‚¨æ•ˆç‡ã€‚  
> - ğŸ“º **è§†é¢‘æ•™ç¨‹**ï¼šğŸš§ *å¼€å‘ä¸­*  
> - ğŸ’¾ **ç¤ºä¾‹ä»£ç **ï¼š[ESP32-Guide/code/04.peripheral/storage/partition](https://github.com/DuRuofu/ESP32-Guide/tree/main/code/04.peripheral/storage/partition)


> **flash**: å®ƒåœ¨åµŒå…¥å¼ç³»ç»Ÿä¸­çš„åŠŸèƒ½å¯ä»¥å’Œç¡¬ç›˜åœ¨PCä¸­çš„åŠŸèƒ½ç›¸æ¯”ã€‚å®ƒä»¬éƒ½æ˜¯ç”¨æ¥å­˜å‚¨ç¨‹åºå’Œæ•°æ®çš„ï¼Œå¥½æ¯”æ˜¯ROMã€‚è€Œä¸”å¯ä»¥åœ¨æ‰ç”µçš„æƒ…å†µä¸‹ç»§ç»­ä¿å­˜æ•°æ®ä½¿å…¶ä¸ä¼šä¸¢å¤±ã€‚Flash memoryï¼ˆé—ªé€Ÿå­˜å‚¨å™¨ï¼‰ä½œä¸ºä¸€ç§å®‰å…¨ã€å¿«é€Ÿçš„å­˜å‚¨ä½“ï¼Œå…·æœ‰ä½“ç§¯å°ï¼Œå®¹é‡å¤§ï¼Œæˆæœ¬ä½ï¼Œæ‰ç”µæ•°æ®ä¸ä¸¢å¤±ç­‰ä¸€ç³»åˆ—ä¼˜ç‚¹ï¼Œå·²æˆä¸ºåµŒå…¥å¼ç³»ç»Ÿä¸­æ•°æ®å’Œç¨‹åºæœ€ä¸»è¦çš„è½½ä½“ã€‚æ ¹æ®ç»“æ„çš„ä¸åŒå¯ä»¥å°†å…¶åˆ†ä¸º**NOR Flash**å’Œ**NAND Flash**ä¸¤ç§ã€‚NOR Flashçš„ç‰¹ç‚¹æ˜¯åº”ç”¨ç¨‹åºå¯ä»¥ç›´æ¥åœ¨é—ªå­˜ä¸­è¿è¡Œï¼Œä¸éœ€è¦å†æŠŠä»£ç è¯»åˆ°ç³»ç»ŸRAMä¸­è¿è¡Œã€‚NAND Flashä¸è¡Œã€‚è€Œæˆ‘ä»¬å•ç‰‡æœºåŸºæœ¬éƒ½æ˜¯NOR FLASNã€‚

åˆ†åŒºè¡¨æ˜¯åˆ’åˆ†ESP32å†…éƒ¨flashçš„è§„åˆ™è¡¨ï¼Œå®ƒå°† flash åˆ’åˆ†ä¸ºå¤šä¸ªä¸åŒåŠŸèƒ½çš„åŒºåŸŸç”¨äºå…¶ä»–åŠŸèƒ½ã€‚

æ¯ç‰‡ ESP32 çš„ flash å¯ä»¥åŒ…å«å¤šä¸ªåº”ç”¨ç¨‹åºï¼Œä»¥åŠå¤šç§ä¸åŒç±»å‹çš„æ•°æ®ï¼ˆä¾‹å¦‚æ ¡å‡†æ•°æ®ã€æ–‡ä»¶ç³»ç»Ÿæ•°æ®ã€å‚æ•°å­˜å‚¨æ•°æ®ç­‰ï¼‰ï¼Œå› æ­¤ï¼Œæˆ‘ä»¬åœ¨ flash çš„Â é»˜è®¤åç§»åœ°å€Â 0x8000 å¤„çƒ§å†™ä¸€å¼ åˆ†åŒºè¡¨ã€‚

åˆ†åŒºè¡¨çš„é•¿åº¦ä¸º 0xC00 å­—èŠ‚ï¼Œæœ€å¤šå¯ä»¥ä¿å­˜ 95 æ¡åˆ†åŒºè¡¨æ¡ç›®ã€‚MD5 æ ¡éªŒå’Œé™„åŠ åœ¨åˆ†åŒºè¡¨ä¹‹åï¼Œç”¨äºåœ¨è¿è¡Œæ—¶éªŒè¯åˆ†åŒºè¡¨çš„å®Œæ•´æ€§ã€‚

åˆ†åŒºè¡¨å æ®äº†æ•´ä¸ª flash æ‰‡åŒºï¼Œå¤§å°ä¸º 0x1000 (4 KB)ã€‚å› æ­¤ï¼Œå®ƒåé¢çš„ä»»ä½•åˆ†åŒºè‡³å°‘éœ€è¦ä½äº ([é»˜è®¤åç§»åœ°å€](https://docs.espressif.com/projects/esp-idf/zh_CN/latest/esp32/api-reference/kconfig.html#config-partition-table-offset)) + 0x1000 å¤„ã€‚

åˆ†åŒºè¡¨ä¸­çš„æ¯ä¸ªæ¡ç›®éƒ½åŒ…æ‹¬ä»¥ä¸‹å‡ ä¸ªéƒ¨åˆ†ï¼šNameï¼ˆæ ‡ç­¾ï¼‰ã€Typeï¼ˆappã€data ç­‰ï¼‰ã€SubType ä»¥åŠåœ¨ flash ä¸­çš„åç§»é‡ï¼ˆåˆ†åŒºçš„åŠ è½½åœ°å€ï¼‰ã€‚

### 1.1 åˆ†åŒºè¡¨å­—æ®µè¯¦è§£ï¼š

##### **(1) åŸºæœ¬**
- å­—æ®µä¹‹é—´çš„ç©ºå­—ç¬¦ä¼šè¢«å¿½ç•¥ï¼Œä»»ä½•ä»¥ # å¼€å¤´çš„è¡Œï¼ˆæ³¨é‡Šï¼‰éƒ½ä¼šè¢«å¿½ç•¥ã€‚
- CSV æ–‡ä»¶ä¸­çš„æ¯ä¸ªéæ³¨é‡Šè¡Œå‡ä¸ºä¸€ä¸ªåˆ†åŒºå®šä¹‰ã€‚
- æ¯ä¸ªåˆ†åŒºçš„Â `Offset`Â å­—æ®µå¯ä»¥ä¸ºç©ºï¼Œ`gen_esp32part.py`Â å·¥å…·ä¼šä»åˆ†åŒºè¡¨ä½ç½®çš„åé¢å¼€å§‹è‡ªåŠ¨è®¡ç®—å¹¶å¡«å……è¯¥åˆ†åŒºçš„åç§»åœ°å€ï¼ŒåŒæ—¶ç¡®ä¿æ¯ä¸ªåˆ†åŒºçš„åç§»åœ°å€æ­£ç¡®å¯¹é½ã€‚

##### **(2) Name â€”â€” åˆ†åŒºå**
- Name å­—æ®µå¯ä»¥æ˜¯ä»»ä½•æœ‰æ„ä¹‰çš„åç§°ï¼Œä½†ä¸èƒ½è¶…è¿‡ 16 ä¸ªå­—ç¬¦ï¼ˆä¹‹åçš„å†…å®¹å°†è¢«æˆªæ–­ï¼‰ã€‚è¯¥å­—æ®µå¯¹ ESP32 å¹¶ä¸æ˜¯ç‰¹åˆ«é‡è¦ã€‚

##### **(3) Type â€”â€” ä¸»ç±»å‹**
- Type å­—æ®µå¯ä»¥æŒ‡å®šä¸º app (0x00) æˆ–è€… data (0x01)ï¼Œä¹Ÿå¯ä»¥ç›´æ¥ä½¿ç”¨æ•°å­— 0-254ï¼ˆæˆ–è€…åå…­è¿›åˆ¶ 0x00-0xFEï¼‰ã€‚æ³¨æ„ï¼Œ0x00-0x3F ä¸å¾—ä½¿ç”¨ï¼ˆé¢„ç•™ç»™ esp-idf çš„æ ¸å¿ƒåŠŸèƒ½ï¼‰ã€‚

#####  (4) SubType â€”â€” å­ç±»å‹

- å­ç±»å‹ç”¨äºæ˜ç¡®å…·ä½“ç±»å‹ï¼Œè¯¥å­—æ®µæœ¬è´¨ä¸Šä¸ºé•¿åº¦ 8 bit çš„æ•°å­—ï¼Œå†…å®¹ä¸å…·ä½“åˆ†åŒº Type æœ‰å…³ã€‚ç›®å‰ï¼Œesp-idf ä»…ä»…è§„å®šäº†Â `â€œappâ€`Â å’ŒÂ `â€œdataâ€`Â ä¸¤ç§åˆ†åŒºç±»å‹çš„å­ç±»å‹å«ä¹‰ã€‚

- ç›®å‰esp-idfèƒ½è¯†åˆ«çš„å·²çŸ¥å…³é”®å­—æœ‰ï¼š
	app ç±»å‹ä¸‹ï¼šf`actory, test, ota_0, ota_1, ota_2, ota_3, ota_4, ota_5, ota_6, ota_7, ota_8, ota_9, ota_10, ota_11, ota_12, ota_13, ota_14, ota_15`
	data ç±»å‹ä¸‹ï¼š`ota, phy, nvs, coredump, nvs_keys, efuse, esphttpd, fat, spiffs`
	
##### **(5) Offset & Size â€”â€” åç§»åœ°å€ & åˆ†åŒºå¤§å°**
 
- åç§»åœ°å€è¡¨ç¤º SPI flash ä¸­çš„åˆ†åŒºåœ°å€ï¼Œæ‰‡åŒºå¤§å°ä¸º 0x1000 (4 KB)ã€‚å› æ­¤ï¼Œåç§»åœ°å€å¿…é¡»æ˜¯ 4 KB çš„å€æ•°ã€‚è¯­æ³•ä¸Šåˆ†åŒºçš„å¤§å°å’Œåç§»åœ°å€å¯ä»¥é‡‡ç”¨ä»¥ä¸‹è¡¨ç¤ºæ–¹æ³•ï¼š
	 - åè¿›åˆ¶æ•°ï¼ˆæ”¯æŒ K æˆ– M çš„å€æ•°å•ä½ï¼ˆåˆ†åˆ«ä»£è¡¨Â `1024`Â å’ŒÂ `1024Â²`Â å­—èŠ‚ï¼‰
	 - ä»¥Â `0x`Â ä¸ºå‰ç¼€çš„åå…­è¿›åˆ¶æ•°.
	   
- è‹¥ CSV æ–‡ä»¶ä¸­çš„åˆ†åŒºåç§»åœ°å€ä¸ºç©ºï¼Œåˆ™è¯¥åˆ†åŒºä¼šæ¥åœ¨å‰ä¸€ä¸ªåˆ†åŒºä¹‹åï¼›è‹¥ä¸ºé¦–ä¸ªåˆ†åŒºï¼Œåˆ™å°†æ¥åœ¨åˆ†åŒºè¡¨ä¹‹åã€‚
- `app`Â åˆ†åŒºçš„åç§»åœ°å€å¿…é¡»ä¸ 0x10000 (64 KB) å¯¹é½ã€‚å¦‚æœåç§»å­—æ®µç•™ç©ºï¼Œåˆ™Â `gen_esp32part.py`Â å·¥å…·ä¼šè‡ªåŠ¨è®¡ç®—å¾—åˆ°ä¸€ä¸ªæ»¡è¶³å¯¹é½è¦æ±‚çš„åç§»åœ°å€ã€‚å¦‚æœÂ `app`Â åˆ†åŒºçš„åç§»åœ°å€æ²¡æœ‰ä¸ 0x10000 (64 KB) å¯¹é½ï¼Œåˆ™è¯¥å·¥å…·ä¼šæŠ¥é”™ã€‚
- `app`Â åˆ†åŒºçš„å¤§å°å¿…é¡»ä¸ flash æ‰‡åŒºå¤§å°å¯¹é½ã€‚ä¸ºÂ `app`Â åˆ†åŒºæŒ‡å®šæœªå¯¹é½çš„å¤§å°å°†è¿”å›é”™è¯¯ã€‚
- è‹¥å¯ç”¨äº†å®‰å…¨å¯åŠ¨ V1ï¼Œåˆ™Â `app`Â åˆ†åŒºçš„å¤§å°éœ€ä¸ 0x10000 (64 KB) å¯¹é½ã€‚
- `app`Â åˆ†åŒºçš„å¤§å°å’Œåç§»åœ°å€å¯ä»¥é‡‡ç”¨åè¿›åˆ¶æ•°æˆ–æ˜¯ä»¥ 0x ä¸ºå‰ç¼€çš„åå…­è¿›åˆ¶æ•°ï¼Œä¸”æ”¯æŒ K æˆ– M çš„å€æ•°å•ä½ï¼ˆK å’Œ M åˆ†åˆ«ä»£è¡¨ 1024 å’Œ 1024*1024 å­—èŠ‚ï¼‰ã€‚

##### **(6) Flag â€”â€” æ ‡è®°**

ç›®å‰æ”¯æŒÂ `encrypted`Â å’ŒÂ `readonly`Â æ ‡è®°ï¼š

- å¦‚æœ Flags å­—æ®µè®¾ç½®ä¸ºÂ `encrypted`ï¼Œä¸”å·²å¯ç”¨ Flash åŠ å¯† åŠŸèƒ½ï¼Œåˆ™è¯¥åˆ†åŒºå°†ä¼šè¢«åŠ å¯†ã€‚æ³¨ï¼šæ— è®ºæ˜¯å¦è®¾ç½® Flags å­—æ®µï¼Œ`app`Â åˆ†åŒºéƒ½å°†ä¿æŒåŠ å¯†ã€‚

- å¦‚æœ Flags å­—æ®µè®¾ç½®ä¸ºÂ `readonly`ï¼Œåˆ™è¯¥åˆ†åŒºä¸ºåªè¯»åˆ†åŒºã€‚`readonly`Â æ ‡è®°ä»…æ”¯æŒé™¤Â `ota`Â å’ŒÂ `coredump`Â å­ç±»å‹å¤–çš„Â `data`Â åˆ†åŒºã€‚ä½¿ç”¨è¯¥æ ‡è®°ï¼Œé˜²æ­¢æ„å¤–å†™å…¥å¦‚å‡ºå‚æ•°æ®åˆ†åŒºç­‰åŒ…å«å…³é”®è®¾å¤‡ç‰¹å®šé…ç½®æ•°æ®çš„åˆ†åŒºã€‚

### 1.2 å†…ç½®åˆ†åŒºè¡¨

æ‰“å¼€é¡¹ç›®é…ç½®èœå•ï¼ˆ`idf.pyÂ menuconfig`ï¼‰ï¼Œå¯ä»¥åœ¨Â [CONFIG_PARTITION_TABLE_TYPE](https://docs.espressif.com/projects/esp-idf/zh_CN/latest/esp32/api-reference/kconfig.html#config-partition-table-type)Â ä¸‹çœ‹åˆ°å†…ç½®é¢„å®šä¹‰çš„åˆ†åŒºè¡¨ï¼š
- "Single factory app, no OTA"ï¼ˆå•APPï¼Œæ— OTAåˆ†åŒºï¼‰
- "Factory app, two OTA definitions"ï¼ˆå•APP + ä¸¤ä¸ªOTAåˆ†åŒºï¼‰
![](attachments/20240306095441.png)
åœ¨ä»¥ä¸Šä¸¤ç§é€‰é¡¹ä¸­ï¼Œå‡ºå‚åº”ç”¨ç¨‹åºå‡å°†è¢«çƒ§å½•è‡³ flash çš„ 0x10000 åç§»åœ°å€å¤„ã€‚

> è¿è¡ŒÂ `idf.py partition-tabl`Â ï¼Œå³å¯ä»¥æ‰“å°å½“å‰ä½¿ç”¨åˆ†åŒºè¡¨çš„ä¿¡æ¯æ‘˜è¦ã€‚


ä¸‹å›¾æ˜¯Â "Single factory app, no OTA" é€‰é¡¹çš„åˆ†åŒºè¡¨ä¿¡æ¯æ‘˜è¦:

![](attachments/0240306095603.png)

- flash çš„ 0x10000 (64 KB) åç§»åœ°å€å¤„å­˜æ”¾ä¸€ä¸ªæ ‡è®°ä¸º "factory" çš„äºŒè¿›åˆ¶åº”ç”¨ç¨‹åºï¼Œä¸”å¯åŠ¨åŠ è½½å™¨å°†é»˜è®¤åŠ è½½è¿™ä¸ªåº”ç”¨ç¨‹åºã€‚
- åˆ†åŒºè¡¨ä¸­è¿˜å®šä¹‰äº†ä¸¤ä¸ªæ•°æ®åŒºåŸŸï¼Œåˆ†åˆ«ç”¨äºå­˜å‚¨ NVS åº“ä¸“ç”¨åˆ†åŒºå’Œ PHY åˆå§‹åŒ–æ•°æ®ã€‚


ä¸‹å›¾æ˜¯Â "Factory app, two OTA definitions" é€‰é¡¹çš„åˆ†åŒºè¡¨ä¿¡æ¯æ‘˜è¦:

``` c
# ESP-IDF Partition Table
# Name,   Type, SubType, Offset,  Size, Flags
nvs,      data, nvs,     0x9000,  0x4000,
otadata,  data, ota,     0xd000,  0x2000,
phy_init, data, phy,     0xf000,  0x1000,
factory,  app,  factory, 0x10000,  1M,
ota_0,    app,  ota_0,   0x110000, 1M,
ota_1,    app,  ota_1,   0x210000, 1M,
```

- åˆ†åŒºè¡¨ä¸­å®šä¹‰äº†ä¸‰ä¸ªåº”ç”¨ç¨‹åºåˆ†åŒºï¼Œè¿™ä¸‰ä¸ªåˆ†åŒºçš„ç±»å‹éƒ½è¢«è®¾ç½®ä¸º â€œappâ€ï¼Œä½†å…·ä½“ app ç±»å‹ä¸åŒã€‚å…¶ä¸­ï¼Œä½äº 0x10000 åç§»åœ°å€å¤„çš„ä¸ºå‡ºå‚åº”ç”¨ç¨‹åº (factory)ï¼Œå…¶ä½™ä¸¤ä¸ªä¸º OTA åº”ç”¨ç¨‹åºï¼ˆota_0ï¼Œota_1ï¼‰ã€‚
- æ–°å¢äº†ä¸€ä¸ªåä¸º â€œotadataâ€ çš„æ•°æ®åˆ†åŒºï¼Œç”¨äºä¿å­˜ OTA å‡çº§æ—¶éœ€è¦çš„æ•°æ®ã€‚å¯åŠ¨åŠ è½½å™¨ä¼šæŸ¥è¯¢è¯¥åˆ†åŒºçš„æ•°æ®ï¼Œä»¥åˆ¤æ–­è¯¥ä»å“ªä¸ª OTA åº”ç”¨ç¨‹åºåˆ†åŒºåŠ è½½ç¨‹åºã€‚å¦‚æœ â€œotadataâ€ åˆ†åŒºä¸ºç©ºï¼Œåˆ™ä¼šæ‰§è¡Œå‡ºå‚ç¨‹åºã€‚

### 1.3 è‡ªå®šä¹‰åˆ†åŒºè¡¨

å†…ç½®åˆ†åŒºè¡¨åŠŸèƒ½å¾ˆå°‘ï¼Œä¾‹å¦‚æ— æ–‡ä»¶ç³»ç»Ÿç­‰åˆ†åŒºã€‚æˆ‘ä»¬å¦‚æœæƒ³è¦ä½¿ç”¨æ–‡ä»¶ç³»ç»Ÿå°±è¦è‡ªå®šä¹‰åˆ†åŒºè¡¨ã€‚

ä½¿ç”¨è‡ªå®šä¹‰åˆ†åŒºè¡¨æ—¶ï¼Œè¦å…ˆåœ¨å·¥ç¨‹æ ¹ç›®å½•ä¸‹æ–°å»ºä¸€ä¸ª`*.csv`æ–‡ä»¶ï¼Œå†…å®¹æŒ‰ç…§ä¸Šæ–‡è§„åˆ™ç¼–å†™è‡ªå®šä¹‰åˆ†åŒºè¡¨ã€‚åˆ†åŒºè¡¨æ–‡ä»¶åéšæ„ã€‚å¦‚ä¸‹`partitions.csv`

``` c
$ your_project
.
â”œâ”€â”€ main
â”‚   â”œâ”€â”€ CMakeLists.txt
â”‚   â””â”€â”€ Hello.cpp
â”œâ”€â”€ CMakeLists.txt
â””â”€â”€ partitions.csv	  #è¿™ä¸ªæ–‡ä»¶
```

ä¹‹åæ‰“å¼€`idf.py menuconfig`Â å‚è€ƒä¸Šæ–‡æ‰“å¼€åˆ†åŒºè¡¨è®¾ç½®ç•Œé¢ï¼Œé€‰æ‹©ç¬¬ä¸‰é¡¹â€œè‡ªå®šä¹‰åˆ†åŒºè¡¨Â `CSV`æ–‡ä»¶â€
ç„¶åå¡«å†™è‡ªå·±çš„åˆ†åŒºè¡¨å³å¯ã€‚
![](attachments/2.png)


ä¹‹åä½¿ç”¨`idf.py build`Â å’ŒÂ `idf.py flash`å³å¯ç¼–è¯‘å¹¶çƒ§å½•æ•´ä¸ªåº”ç”¨ç¨‹åºã€‚

>æ³¨ï¼šå¦‚æœåªæ˜¯æƒ³ç¼–è¯‘åˆ†åŒºè¡¨ï¼Œè¯·ç”¨`idf.py partition_table`Â å’Œ`idf.py partition_table-flash`åˆ†åˆ«æ¥ç¼–è¯‘å’Œçƒ§å½•åˆ†åŒºè¡¨ã€‚

# å‚è€ƒé“¾æ¥

1. https://docs.espressif.com/projects/esp-idf/zh_CN/latest/esp32/api-guides/partition-tables.html