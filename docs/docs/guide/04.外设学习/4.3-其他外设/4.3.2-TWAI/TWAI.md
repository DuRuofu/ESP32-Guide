# 双线汽车接口 (TWAI) -（CAN）

> [!TIP] 🚀 ESP32 外设之双线汽车接口 (TWAI)  | 
> - 💡 **碎碎念**😎：本节将介绍 ESP32 的双线汽车接口 (TWAI) ,他是是一种适用于汽车和工业应用的实时串行通信协议。
> - 📺 **视频教程**：🚧 *开发中*  
> - 💾 **示例代码**：🚧 *开发中*

双线汽车接口 (TWAI) 是一种适用于汽车和工业应用的实时串行通信协议。它兼容 ISO11898-1 经典帧，因此可以支持标准帧格式（11 位 ID）和扩展帧格式（29 位 ID）。ESP32 包含 1 个 TWAI 控制器，经配置可以在 TWAI 总线上使用外部收发器通信。

注意：TWAI 控制器不兼容 ISO11898-1 FD 格式帧，并会将这些帧解析为错误。

## 一、前言简介

- 简介：TWAI（Two-Wire Automotive Interface）是 ESP32 提供的 CAN 协议兼容实现。
- 协议兼容性：支持 ISO11898-1 标准帧和扩展帧格式，不支持 CAN-FD。
- 应用场景：
  - 车载设备通信
  - 工业自动化系统
  - 多主多从嵌入式网络

---

## 二、协议基础

- TWAI = Classic CAN（兼容）
- 帧格式：
  - 标准帧（11 位 ID）
  - 扩展帧（29 位 ID）
  - 数据帧、远程帧、错误帧
- 仲裁机制与优先级
- 位定时与波特率选择（如 500kbps）

---

## 三、硬件准备

- ESP32 模块（推荐 WROOM/WROVER 系列）
- CAN 收发器（如 SN65HVD230、TJA1050）
- 接线说明：
  - ESP32 TX ➝ 收发器 TXD
  - ESP32 RX ➝ 收发器 RXD
  - CANH、CANL ➝ 总线
- 加 120Ω 终端电阻于总线两端
- 电源要求与隔离建议（如长距离通信建议使用隔离型收发器）

---

## 四、软件环境配置（ESP-IDF）

- 驱动初始化步骤：
  - `twai_driver_install()`
  - `twai_start()`
- 主要结构体：
  - `twai_message_t`：数据帧定义
  - `twai_general_config_t`、`twai_timing_config_t`、`twai_filter_config_t`
- 示例配置波特率、引脚、模式等参数
- 使用 FreeRTOS 任务接收数据（推荐）

---

## 五、发送与接收示例

- ✅ 发送帧示例（标准帧、扩展帧）
- ✅ 接收帧示例（阻塞与非阻塞）
- 🔁 循环发送测试数据
- 🛑 超时处理和帧校验
- 🚦 使用中断或轮询方式收发

---

## 六、调试与验证

- 使用逻辑分析仪/示波器查看 CANH/CANL 波形
- 多设备组网互通验证（例如连接另一个 STM32/开发板）
- 常见问题排查：
  - 没有数据 ➝ 检查终端电阻、电压、接线
  - 接收错误 ➝ 检查帧格式、波特率一致性
  - 控制器状态 ➝ 使用 `twai_get_status_info()` 查看错误码

---

## 七、高级应用（可选）

- 设置 ID 过滤器（精确匹配 / 范围匹配）
- 发送优先级控制（低 ID = 高优先级）
- 状态监测：总线关闭、错误计数
- 灵活切换正常模式 / 回环模式 / 监听模式

---

## 八、总结与资料

- 官方文档：
  - [ESP-IDF TWAI 文档](https://docs.espressif.com/projects/esp-idf/zh/latest/esp32/api-reference/peripherals/twai.html)
- 推荐资料：
  - CAN 协议详解（推荐阅读 Bosch CAN spec）
  - 收发器芯片选型参考
- 视频教程：🚧 *开发中*
- 示例代码：🚧 *开发中*
